# Domain 04: Recoding System (리코딩 및 게시물 생성)

**기반 데이터**:

- **Consolidated Domains**: D01, D02, D03, D05, D06, D07, D08, D09, D11, D12,
  D14.
- **Philosophy (From Domain 01)**: "Make vs Upload Separation" (배치 프로세싱) &
  "Hyper-Reality".

---

## 1. Process Definition: Make vs Upload

본 시스템은 **'만들기(Make)'**와 **'올리기(Upload)'**를 물리적으로 분리합니다.

- **Make (생성)**: 촬영 및 AI 합성을 통해 결과물을 만들고 '보관함'에 저장하는
  개인적 단계.
- **Upload (게시)**: 보관함에 저장된 룩(Look)을 선택하여 실제 피드에 공개하는
  사회적 단계.

---

## 2. Phase 1: Creation (Make) - 3-Slot Batch System

### 2.1 Entry UI (Platform Specific)

- **Web**: 현재 보고 있는 피드 위에 **'업로드 모달(Overlay)'**이 팝업됨 (Flow
  유지).
- **Mobile**: 별도의 **'생성 페이지(New Activity)'**로 화면 전환 (집중도 향상).
- **Auto Load**: 진입 시 유저의 **'온보딩 아바타(Base Body)'**가 중앙에 자동
  로드됨.
- **Entry Choice**:
  - **Image Generation**: 기존의 3-Slot AI 이미지 생성 모드 (기본).
  - **Pose Creation**: 자신의 몸을 움직여 새로운 포즈를 만드는 모드 (New).

### 2.2 3-Slot Configuration

유저는 **단 한 번의 세션**으로 최대 **3개의 서로 다른 스타일**을 생성할 수
있습니다.

- **Structure**: 화면 하단에 `[Slot 1]`, `[Slot 2]`, `[Slot 3]` 탭 제공.
- **Per Slot Settings**:
  1. **Pose**: 포즈샵에서 보유한 포즈 선택.
  2. **Mask**: 가면샵에서 보유한 가면 선택 (ON/OFF 가능).
  3. **Background**: 분위기에 맞는 배경 선택.
- **Credit Logic**: 생성 완료 시, 활성화된 **'슬롯의 개수'만큼** 일일 생성
  횟수(Film)가 즉시 차감됩니다.

### 2.3 AI Model Tiering (차등 엔진 적용)

유저의 멤버십 등급(Domain 07)에 따라 리코딩에 사용되는 AI 모델의 '지능'과 '화질'이 달라진다.

1.  **Standard Engine (Free/Basic)**
    * **Model**: Gemini 1.5 Flash.
    * **Performance**: 빠른 생성 속도, 표준 해상도(Standard-Res).
    * **Cost**: 플랫폼 운영 비용 최소화를 위한 가성비 엔진.

2.  **Professional Engine (PRO Membership)**
    * **Model**: Gemini 1.5 Pro.
    * **Performance**: 복잡한 의상 텍스처(질감)와 조명(Lighting)을 초정밀하게 이해하고 표현한다.
    * **Priority**: 대기열(Queue) 진입 시 '우선 처리권(Fast Track)'을 부여받아 대기 시간이 단축된다.
---

## 3. Phase 2: Recoding (One-Shot Camera Input)

### 3.1 Ghost Overlay (Alignment)

- **Problem**: 매번 위치를 잡기 어려운 셀프 촬영.
- **Solution**: 촬영 화면에 유저의 **Base Avatar 실루엣(Ghost)**을 반투명하게
  오버레이.
- **Action**: 유저는 이 가이드에 자신의 몸을 맞춰 거리/각도를 정밀 동기화합니다.

### 3.2 One-Shot Recoding (4-Angle Capture)

- **Efficiency**: 설정한 슬롯이 3개라도, 촬영은 **단 1회(앞/뒤/좌/우)**만
  수행합니다.
- **Logic**: 여기서 확보된 **하나의 '의상 설계도(Deco)'**를 앞서 설정한 **3개의
  슬롯(포즈/배경)**에 각각 수학적으로 투영(Multi-Generation)합니다.

### 3.3 Volumetric Subtraction (Deco Extraction)

AI의 상상(Hallucination)이 아닌, **팩트 기반의 차분(Subtraction)** 기술을
사용합니다.

- **Formula**:
  `(Current Capture Volume) - (Known Base Body Volume) = Deco Volume`
- **Result**: 몸 바깥으로 튀어나온 패딩 두께, 치마 주름, 머리카락 부피만을
  노이즈 없이 정교하게 추출.
- **Blueprint**: 추출된 Deco 영역은 **'UV Texture Atlas(전개도)'** 형태로
  변환되어 저장됩니다.

### 3.4 Emotional Loading

- **UI**: 기계적인 로딩 바 대신 유저의 마음을 대변하는 문구 출력.
- **Copy**: "제발 예쁘게 나오기를...", "옷 핏을 맞추고 있어요...", "인생샷
  건지는 중...".

---

## 4. Phase 3: Editing & Archiving

### 4.1 Composition Formula (Final Rendering)

$$Final Image = (Base Body + Eye Color) + (Deco Blueprint) + (Pose) + (Mask) + (Background)$$

위 공식에 따라 3장의 결과물이 동시에 렌더링됩니다.

### 4.2 Individual Edit

- **Zoom**: 핀치 줌으로 최적의 구도(Crop) 설정.
- **Filter**: 색감/분위기 보정만 허용 (형태 왜곡/성형 불가).
- **Text**: 사진 위에 텍스트 배치 (블로그/인스타 스토리 스타일).

### 4.3 Naming & Save

- **Naming**: "이 룩(Look)의 이름을 지어주세요" (예: 2/4 벚꽃 데이트).
- **Archiving**: 저장 시 **'내 보관함'**으로 이동하며 Make 과정 종료 (비공개
  상태).

---

## 5. Phase 4: Upload & Lifecycle

### 5.1 Upload Process

- **Access**: 언제든지 '업로드 탭'에서 보관함 확인 가능.
- **Publish**: 원하는 룩 묶음을 선택하여 [업로드] 클릭 시 피드에 공개.
- **Auto Tagging**: 사용된 포즈, 가면, 의상 정보가 자동 태그됨.

### 5.2 Item Lifecycle (Survival)

- **Count Up**: 게시물 업로드 시, 사용된 포즈/가면의 **[총 사용 횟수] +1**.
- **Count Down**: 게시물 삭제 시, 해당 아이템의 **[총 사용 횟수] -1**.
- **Delisting (자동 비노출)**: 삭제로 인해 사용 횟수가 **0**이 되는 순간, 해당
  아이템은 **상점(Shop) 판매 목록에서 즉시 비노출(Delisted)** 처리됩니다.
- **Effect**: 유저는 자신이 좋아하는 아이템을 살리기 위해(단종 방지) 게시물을
  유지할 강력한 동기를 갖습니다.

---

## 6. Pose Creation System (신규: 포즈 생성)

### 6.1 Process Flow

1. **Entry**: 리코딩 진입 시 **[Pose Creation]** 선택.
2. **Access**: 카메라 권한 승인 후 전신 촬영 모드 진입.
3. **Timer Setup**: 유저가 준비할 시간(3초/5초/10초) 설정.
4. **Capture**: 화면 터치 -> 타이머 시작 -> 종료 시점의 프레임(Frame) 캡처.

### 6.2 Skeleton Extraction Algorithm

- **Target**: 화면 내에서 **가장 대표적인(가장 크게 인식된) 한 사람**의 포즈만
  분석.
- **Detail**:
  - **Joints**: 어깨, 팔꿈치, 무릎 등 주요 관절.
  - **Extremities**: 손가락(Finger), 발가락(Toe) 끝까지 정밀 추적.
  - **Head**: 고개 젖힘(Tilt), 회전각(Rotation) 포함.
- **Output**: 추출된 뼈대 데이터를 `.json` 형태의 자체 규격 포즈 파일로 변환.

### 6.3 Usage & Commercialization (상업화 규칙)

생성된 포즈는 개인 소장(Collection)이 기본이며, 상점 등록 시 철저한 등급별 정산 비율이 적용된다.

1.  **Personal Use (소장)**
    * 생성된 포즈는 'My Pose Collection'에 영구 저장되며, 본인은 횟수 제한 없이 무료로 사용 가능하다.

2.  **Public Registration (판매 등록)**
    * **Revenue Split (수익 배분)**:
        * **Regular User (일반)**: 판매 수익의 **4%**만 정산받는다.
          *(계산: 1티켓 판매 시 약 0.8필름 획득. 즉, 25개를 팔아야 티켓 1개 값을 회수하는 구조. 철저한 어뷰징 방지 및 인플레이션 억제).*
        * **Fashionista (Creator)**: 판매 수익의 **80%**를 정산받는다.
          *(계산: 1티켓 판매 시 0.8티켓 상당의 Revenue 획득. 수익 창출을 위한 강력한 동기 부여).*
    * **Currency**: 일반 유저는 생태계 내 재화(Film)로, 패셔니스타는 현금화 가능한 포인트(Revenue)로 지급된다.

---

## 7. Infrastructure Protocols (System Safety)

**[Domain 13]**의 'Local Python Server(GPU)' 환경에서 대량의 리코딩 요청을 안정적으로 처리하기 위한 기술적 규약.

### 7.1 Async Queue Management (대기열)

GPU 자원은 한정되어 있으므로, 모든 생성 요청은 '선입선출(FIFO)' 대기열을 통과한다.

1.  **Ticket System (번호표 발급)**
    * 유저가 [생성 시작] 버튼을 누르면, 요청은 즉시 처리되지 않고 `recoding_queue` 테이블에 `status: 'PENDING'`으로 등록된다.
    * 앱 UI에는 **"작업 대기 중... (현재 대기: 3명)"**과 같은 예상 대기 상태가 실시간으로 표시된다.
2.  **Worker Fetching (순차 처리)**
    * Local Server는 1초 간격으로 대기열을 확인(Polling)하여, GPU 메모리가 허용하는 한도(예: 1회 2작업) 내에서만 요청을 가져가(Fetch) 처리한다.
    * 처리가 완료되면 `status: 'COMPLETED'`로 변경하고, **Supabase Realtime**을 통해 유저에게 알림을 보낸다.

### 7.2 Fail-Safe & Auto-Refund (실패 보상)

AI 생성 실패 시 유저의 재화(Film) 손실을 방지하고 불만을 잠재우는 자동 복구 정책.

1.  **Auto-Refund (자동 환불)**
    * Local Server에서 에러(OOM, Timeout)가 발생하거나, 생성된 이미지의 신뢰도가 기준 미달일 경우 `status: 'FAILED'`로 기록된다.
    * 이 경우, 시스템은 소모된 `film` 재화를 즉시 **100% 자동 환불** 처리하며, 유저에게 "AI가 실수를 했네요. 필름을 돌려드렸습니다."라는 메시지를 전송한다.
2.  **Retry Logic (재시도)**
    * 단순 네트워크 오류 등 일시적인 문제는 시스템이 최대 3회까지 조용히 재시도를 수행한다.

### 7.3 Optimization Pipeline (이미지 최적화)

고화질 결과물을 유지하되, 앱 로딩 속도와 스토리지 비용을 절감하기 위한 후처리 과정.

1.  **Format Conversion (포맷 변환)**
    * AI가 생성한 원본(Raw PNG)은 모바일 웹에 최적화된 **WebP (Quality 80%)** 포맷으로 변환되어 저장된다. (용량 90% 절감).
2.  **Dual-Res Storage (이원화 저장)**
    * **Thumbnail**: 피드 노출용 저해상도(Low-Res) 이미지를 별도 생성하여, 리스트 스크롤 시 데이터 소모를 최소화한다.
    * **Original**: 유저가 상세 보기를 클릭하거나 확대(Zoom)할 때만 고해상도(High-Res) 원본을 로딩한다.

### 7.4 Draft Expiration Policy (임시 파일 소각)

스토리지 비용 최적화와 'Digital Darwinism(Domain 01)' 철학을 위한 데이터 수명 주기 관리.

1.  **24-Hour Rule (24시간 규칙)**
    * 'Make(생성)' 단계에서 만들어진 이미지는 `temp_storage` 버킷에 임시 저장된다.
    * 유저가 24시간 내에 'Upload(게시)' 하거나 'Archive(영구 보관)' 하지 않으면, 해당 이미지는 서버에서 **자동으로 소각(Hard Delete)**된다.

2.  **Push Notification (알림)**
    * 만료 1시간 전, "임시 보관함에 있는 룩들이 곧 사라집니다!"라는 푸시 알림을 발송하여 업로드를 유도한다.