-- Verification Script for 070_domain_activity.sql
-- Run this in Supabase SQL Editor.

DO $$
DECLARE
    v_user_id UUID;
    v_user_bad UUID; -- Low reputation
    v_post_id UUID;
    v_likes_count INT;
    v_points_before BIGINT;
    v_points_after BIGINT;
    v_exists BOOLEAN;
BEGIN
    RAISE NOTICE '--- START VERIFICATION: 070_domain_activity ---';

    -- 1. Setup Mock User
    SELECT id INTO v_user_id FROM auth.users LIMIT 1;
    IF v_user_id IS NULL THEN
        RAISE NOTICE 'No users found. Skipping.';
        RETURN;
    END IF;

    -- Ensure high reputation
    UPDATE public.profiles SET reputation = 100 WHERE id = v_user_id;
    
    -- CREATE Bad User (Simulated)
    -- We'll just pick another user or reuse same one if single user env.
    -- If single user, we skip ranking exclusion test or modify reputation temporarily.


    -- 2. Test Quest (First Post)
    RAISE NOTICE 'Testing Quest Reward...';
    
    -- Check initial points
    SELECT points INTO v_points_before FROM public.wallets WHERE user_id = v_user_id;
    IF v_points_before IS NULL THEN v_points_before := 0; END IF;

    -- Clear previous achievement
    DELETE FROM public.user_achievements WHERE user_id = v_user_id AND quest_id = 'FIRST_POST';
    
    -- Create Post
    INSERT INTO public.posts (user_id, storage_path, content) 
    VALUES (v_user_id, 'activity_test', 'Reward Test') 
    RETURNING id INTO v_post_id;

    -- Check Reward
    SELECT points INTO v_points_after FROM public.wallets WHERE user_id = v_user_id;
    IF v_points_after != (v_points_before + 100) THEN
        RAISE EXCEPTION 'Quest Reward Failed! Expected %, Got %', (v_points_before + 100), v_points_after;
    END IF;
    RAISE NOTICE 'Quest Reward Granted (+100).';

    -- 3. Test Idempotency (Delete & Repost)
    RAISE NOTICE 'Testing Quest Idempotency...';
    
    DELETE FROM public.posts WHERE id = v_post_id; -- Trigger should NOT revert reward (it's transaction based, not reversible by delete of post)
    
    -- Create NEW post
    INSERT INTO public.posts (user_id, storage_path, content) 
    VALUES (v_user_id, 'activity_test_2', 'Reward Test 2') 
    RETURNING id INTO v_post_id;
    
    -- Check Points (Should match v_points_after, NO extra reward)
    SELECT points INTO v_points_after FROM public.wallets WHERE user_id = v_user_id;
    IF v_points_after != (v_points_before + 100) THEN
        RAISE EXCEPTION 'Quest Reward Duplicated! Points increased again.';
    END IF;
    RAISE NOTICE 'Quest Idempotency Verified.';


    -- 4. Test Like Logic (Spam Protection)
    RAISE NOTICE 'Testing Like Spam Protection...';
    
    -- Like Once
    INSERT INTO public.likes (user_id, post_id) VALUES (v_user_id, v_post_id);
    
    -- Verify Count
    SELECT likes_count INTO v_likes_count FROM public.posts WHERE id = v_post_id;
    IF v_likes_count != 1 THEN RAISE EXCEPTION 'Like count failed (Expected 1, Got %)', v_likes_count; END IF;
    
    -- Like Again (Should Fail)
    BEGIN
        INSERT INTO public.likes (user_id, post_id) VALUES (v_user_id, v_post_id);
        RAISE EXCEPTION 'Duplicate Like succeeded (Should fail)!';
    EXCEPTION WHEN unique_violation THEN
        RAISE NOTICE 'Duplicate Like blocked correctly.';
    END;
    
    -- Verify Count still 1
    SELECT likes_count INTO v_likes_count FROM public.posts WHERE id = v_post_id;
    IF v_likes_count != 1 THEN RAISE EXCEPTION 'Like count corrupted after failed insert'; END IF;

    -- Unlike
    DELETE FROM public.likes WHERE user_id = v_user_id AND post_id = v_post_id;
     -- Verify Count 0
    SELECT likes_count INTO v_likes_count FROM public.posts WHERE id = v_post_id;
    IF v_likes_count != 0 THEN RAISE EXCEPTION 'Unlike failed to decrement'; END IF;


    -- 5. Test Ranking View
    RAISE NOTICE 'Testing Ranking View...';
    PERFORM * FROM public.ranking_weekly; -- Just check if view is queryable
    
    -- Test Hell Gate
    UPDATE public.profiles SET reputation = 50 WHERE id = v_user_id;
    
    IF EXISTS (SELECT 1 FROM public.ranking_weekly WHERE user_id = v_user_id) THEN
        RAISE EXCEPTION 'Low reputation user appeared in ranking (Hell Gate failed)!';
    END IF;
    
    UPDATE public.profiles SET reputation = 100 WHERE id = v_user_id; -- Restore
    
    -- Cleanup
    DELETE FROM public.posts WHERE id = v_post_id;
    DELETE FROM public.user_achievements WHERE user_id = v_user_id AND quest_id = 'FIRST_POST';

    RAISE NOTICE '--- ALL CHECKS PASSED ---';
END $$;
