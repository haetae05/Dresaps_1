-- Verification Script for 067_domain_wardrobe.sql
-- Run this in Supabase SQL Editor.

DO $$
DECLARE
    v_user_id UUID;
    v_item1_id UUID;
    v_item2_id UUID;
    v_inv1_id UUID;
    v_inv2_id UUID;
    v_equipped BOOLEAN;
BEGIN
    RAISE NOTICE '--- START VERIFICATION: 067_domain_wardrobe ---';

    -- 1. Setup Mock User
    SELECT id INTO v_user_id FROM auth.users LIMIT 1;
    IF v_user_id IS NULL THEN
        RAISE NOTICE 'No users found. Skipping logic tests.';
        RETURN;
    END IF;

    -- 2. Create Mock Items (System Role)
    INSERT INTO public.items (category, brand_name, metadata)
    VALUES ('TOP', 'TestBrand', '{"color":"red"}'::jsonb)
    RETURNING id INTO v_item1_id;

    INSERT INTO public.items (category, brand_name, metadata)
    VALUES ('TOP', 'TestBrand', '{"color":"blue"}'::jsonb)
    RETURNING id INTO v_item2_id;

    -- 3. Grant Items to User (System Role - mimicking Shop/Reward)
    INSERT INTO public.inventory (user_id, item_id, is_equipped)
    VALUES (v_user_id, v_item1_id, FALSE)
    RETURNING id INTO v_inv1_id;

    INSERT INTO public.inventory (user_id, item_id, is_equipped)
    VALUES (v_user_id, v_item2_id, FALSE)
    RETURNING id INTO v_inv2_id;

    -- 4. Test Equip Logic
    -- Equip Item 1
    UPDATE public.inventory SET is_equipped = TRUE WHERE id = v_inv1_id;
    
    -- Verify Item 1 is equipped
    SELECT is_equipped INTO v_equipped FROM public.inventory WHERE id = v_inv1_id;
    IF NOT v_equipped THEN RAISE EXCEPTION 'Item 1 failed to equip'; END IF;

    -- Equip Item 2 (Should unequip Item 1)
    UPDATE public.inventory SET is_equipped = TRUE WHERE id = v_inv2_id;

    -- Verify Item 1 is UNEQUIPPED
    SELECT is_equipped INTO v_equipped FROM public.inventory WHERE id = v_inv1_id;
    IF v_equipped THEN RAISE EXCEPTION 'Item 1 did not unequip automatically!'; END IF;
    
    -- Verify Item 2 is EQUIPPED
    SELECT is_equipped INTO v_equipped FROM public.inventory WHERE id = v_inv2_id;
    IF NOT v_equipped THEN RAISE EXCEPTION 'Item 2 failed to equip'; END IF;

    RAISE NOTICE 'Pass: Auto-Unequip Logic works.';

    -- 5. Test RLS (Insert Block) - Simulation
    -- Checks if policy allows insert on inventory for 'authenticated'
    -- Since we didn't create a policy for INSERT, it defaults to Deny.
    -- We can verify policies exist.
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'inventory' AND cmd = 'INSERT') THEN
         RAISE NOTICE 'Pass: No INSERT policy found for inventory (Implied Deny).';
    ELSE
         RAISE WARNING 'Warning: INSERT policy exists! Check manually if it is for admin only.';
    END IF;

    -- Cleanup (Optional, but keeps test data out of prod if running on live dev db)
    DELETE FROM public.inventory WHERE user_id = v_user_id AND item_id IN (v_item1_id, v_item2_id);
    DELETE FROM public.items WHERE id IN (v_item1_id, v_item2_id);
    
    RAISE NOTICE '--- ALL CHECKS PASSED ---';
END $$;
