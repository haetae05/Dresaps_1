-- [DRESAPS V4.0] Total Pleasure (Domain 13)
-- Section 7.5 Justice, Audit & Section 1.1 Network Optimization
-- Generated by Antigravity Agent

-- 1. Justice & Audit ([Section 7.5, O-02])
-- Hardening the Admin Audit Log created in 007.
-- Strict REVOKE to enforce Append-Only at the Postgres role level.

-- Note: 'admin_audit_logs' already created in 007_final_wiring.sql
-- We strictly REVOKE permissions to ensure "Immutable Justice".

REVOKE UPDATE, DELETE ON public.admin_audit_logs FROM public, authenticated, service_role;

-- [Correction Logic Guide]
-- If an admin makes a mistake, they MUST insert a new row with 'action_type' = 'CORRECTION'.
-- Example: 
-- INSERT INTO public.admin_audit_logs (admin_id, action_type, reason, meta_data)
-- VALUES (aid, 'CORRECTION', 'Reverting previous ban', '{"ref_log_id": "..."}');


-- 2. Device Vital Monitoring ([Section 7.5, O-03])
-- Privacy-preserving device heat monitoring.
-- We do NOT store exact temperature (float). We only store 'Status'.

CREATE TABLE IF NOT EXISTS public.device_vitals (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    battery_level INT CHECK (battery_level BETWEEN 0 AND 100),
    thermal_state TEXT NOT NULL CHECK (thermal_state IN ('GREEN', 'YELLOW', 'RED')), -- [O-03] Qualitative Data Only
    app_version TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS: Device Vitals
ALTER TABLE public.device_vitals ENABLE ROW LEVEL SECURITY;

-- Users can only insert their own vitals
CREATE POLICY "Users insert vitals" 
ON public.device_vitals 
FOR INSERT 
WITH CHECK (auth.uid() = user_id);

-- Only Admins can view vitals (for debugging/support)
CREATE POLICY "Admins view vitals" 
ON public.device_vitals 
FOR SELECT 
USING (
    EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role IN ('admin', 'gm'))
    OR auth.uid() = user_id -- Optional: User can see their own history
);


-- 3. Security Stealth Mode ([Section 6.4])
-- Guide for Function Security:
-- ALWAYS use 'SET search_path = public' to prevent search_path hijacking.
-- This forces the function to only look in 'public' schema for un-qualified table names.

-- Example Enforcement (altering a previous critical function):
CREATE OR REPLACE FUNCTION public.confirm_vital_check()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public -- [Section 6.4] Stealth Mode
AS $$
BEGIN
    -- Monitoring logic placeholder
    RETURN NEW;
END;
$$;


-- 4. Network Optimization ([Section 1.1])
-- [Guide for Supabase Edge Functions / Middleware]
-- Domain 13 mandates 'Content-Encoding' to be set.
-- Supabase Edge Functions (Deno) automatically handle Gzip/Brotli if standard libs are used.
-- However, we strictly advise checking headers:

/* 
   -- SQL Comment Guide --
   Ensure Client Request Headers:
   Accept-Encoding: gzip, deflate, br

   Ensure Server Response Headers:
   Content-Encoding: br (preferred) or gzip
*/
