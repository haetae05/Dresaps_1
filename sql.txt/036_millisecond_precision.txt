-- [DRESAPS V4.0] Millisecond Precision (Domain 13)
-- Section 1.1, 5.1, 2.2, 4.1
-- Generated by Antigravity Agent

-- 1. Network Latency Compensation ([Section 1.1, 10])
-- Adding client-side timestamps to measure and compensate for RTT.

DO $$ 
BEGIN
    BEGIN
        ALTER TABLE public.generation_jobs 
        ADD COLUMN client_sent_at TIMESTAMPTZ,
        ADD COLUMN server_received_at TIMESTAMPTZ DEFAULT NOW();
    EXCEPTION WHEN duplicate_column THEN
        NULL;
    END;
END $$;


-- 2. Season Freeze Grace Period ([Section 5.1, 386])
-- Updating 'safe_rank_freeze' (created in 033) or creating a calculation helper.
-- Rank Calculation must consider logs up to 00:00:03 to account for potential clock skew/latency.

CREATE OR REPLACE FUNCTION public.calculate_final_rank_with_grace()
RETURNS VOID
LANGUAGE plpgsql
AS $$
DECLARE
    v_season_end TIMESTAMPTZ;
BEGIN
    -- e.g. 1st day of month at 00:00:00
    v_season_end := date_trunc('month', NOW());
    
    -- When finalizing ranks, include logs slightly past the boundary
    -- INSERT INTO ranking_history ...
    -- SELECT ... FROM user_measurements
    -- WHERE created_at < (v_season_end + INTERVAL '3 seconds');
    
    -- (Placeholder for the actual complex ranking logic)
    NULL;
END;
$$;


-- 3. Transaction ID-based Sequencing ([Section 2.2, 136])
-- Absolute ordering assurance for ledger and ranking.

DO $$ 
BEGIN
    BEGIN
        ALTER TABLE public.film_ledger 
        ADD COLUMN tx_id BIGINT DEFAULT txid_current();
        
        -- Optional: Add to ranking if exists
        -- ALTER TABLE public.ranking_history ADD COLUMN tx_id BIGINT DEFAULT txid_current();
    EXCEPTION WHEN duplicate_column THEN
        NULL;
    END;
END $$;


-- 4. Micro-precision Queue Fetch ([Section 4.1, 302])
-- Ensure FIFO considers TXID to prevent race conditions in same-millisecond inserts.

CREATE OR REPLACE FUNCTION public.fetch_next_job_precise(p_worker_id UUID, p_types TEXT[])
RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
    v_job JSONB;
BEGIN
    -- Lock: SKIP LOCKED
    -- Order: Priority DESC, CreatedAt ASC, TXID ASC (The Tie-Breaker)
    
    WITH next_job AS (
        SELECT id
        FROM public.generation_jobs
        WHERE status = 'pending'
          AND job_type = ANY(p_types)
        ORDER BY priority DESC, created_at ASC, tx_id ASC
        LIMIT 1
        FOR UPDATE SKIP LOCKED
    )
    UPDATE public.generation_jobs
    SET status = 'processing',
        worker_id = p_worker_id,
        updated_at = NOW(),
        started_at = NOW()
    FROM next_job
    WHERE generation_jobs.id = next_job.id
    RETURNING to_jsonb(generation_jobs.*) INTO v_job;
    
    RETURN v_job;
END;
$$;


-- 5. Recursive Continuity Chain ([Section 4.1, 311])
-- Linking checkpoints to TXID to ensure no gaps.

DO $$ 
BEGIN
    BEGIN
        ALTER TABLE public.job_checkpoints 
        ADD COLUMN last_processed_tx_id BIGINT;
    EXCEPTION WHEN duplicate_column THEN
        NULL;
    END;
END $$;


-- [Final Declaration]
-- Dresaps Infrastructure - Millisecond Precision Complete. The Fairness is Absolute.
