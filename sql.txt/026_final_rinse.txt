-- [DRESAPS V4.0] Final Rinse (Domain 13)
-- Section 6.2, 6.1, 5.2, 4.2
-- Generated by Antigravity Agent

-- 1. Dependency Pinning Protocol ([Section 6.2, 487])
/*
   [Deno Import Map Standard]
   'deno.json' in 'supabase/functions' MUST define imports:
   {
     "imports": {
       "std/": "https://deno.land/std@0.168.0/",
       "postgres": "https://deno.land/x/postgres@v0.17.0/mod.ts"
     }
   }
   Using pinned versions avoids 'works on my machine' issues and prevents supply chain drift.
*/


-- 2. Native Integrity Guard ([Section 6.1, 471])
/*
   [App Integrity Config]
   In 'app.json' / 'app.config.ts':
   
   updates: {
     url: "...",
     codeSigningCertificate: "./certs/cert.pem",
     codeSigningMetadata: { alg: "rsa-sha256", kid: "..." },
     enabled: true,
     checkAutomatically: "ON_LOAD",
     fallbackToCacheTimeout: 0
   },
   runtimeVersion: {
     policy: "fingerprint" // [Crucial]
   }
   
   This ensures clients only pull updates compatible with their native binary.
*/


-- 3. Pre-build Fail-Fast Guard ([Section 6.2, 483])
/*
   [Build Script: check-env.js]
   
   const requiredVars = [
     'EXPO_PUBLIC_SUPABASE_URL', 
     'EXPO_PUBLIC_SUPABASE_ANON_KEY',
     'SENTRY_DSN' 
   ];
   
   requiredVars.forEach(v => {
     if (!process.env[v]) {
       console.error(`[FATAL] Missing Env: ${v}`);
       process.exit(1); 
     }
   });
   console.log("[Env] All required variables present.");
*/


-- 4. Chunked Streaming Recovery ([Section 5.2, 417])
-- State management for resuming interrupted large uploads (Range Request based).

CREATE TABLE IF NOT EXISTS public.streaming_resume_state (
    upload_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    file_path TEXT NOT NULL,
    total_size BIGINT NOT NULL,
    bytes_uploaded BIGINT DEFAULT 0,
    last_chunk_at TIMESTAMPTZ DEFAULT NOW(),
    status TEXT DEFAULT 'uploading' CHECK (status IN ('uploading', 'completed', 'failed')),
    
    expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours'),
    UNIQUE(user_id, file_path)
);

ALTER TABLE public.streaming_resume_state ENABLE ROW LEVEL SECURITY;
CREATE POLICY "User manages own resume state" ON public.streaming_resume_state USING (auth.uid() = user_id);

-- Cleanup Cron for expired sessions
SELECT cron.schedule('prune_streaming_states', '0 * * * *', $$ DELETE FROM public.streaming_resume_state WHERE expires_at < NOW(); $$);


-- 5. Security search_path Hardening ([Section 4.2, 328])
-- Final check. If we missed any generated functions or helpers in previous steps.

DO $$
DECLARE
    f record;
BEGIN
    FOR f IN SELECT proname, pronamespace FROM pg_proc JOIN pg_namespace ON pg_proc.pronamespace = pg_namespace.oid WHERE nspname = 'public' LOOP
        BEGIN
            EXECUTE format('ALTER FUNCTION public.%I SET search_path = public', f.proname);
        EXCEPTION WHEN OTHERS THEN
            -- Ignore specific errors (like aggregates or C functions if any)
            NULL;
        END;
    END LOOP;
END $$;


-- [Final Declaration]
-- Dresaps Infrastructure - Final Rinse Complete. No Residue Left.
