-- [DRESAPS V4.0] Rashisa Identity (Domain 13)
-- Section 2.2, 6.1, 1.2, 1.2, 4.2
-- Generated by Antigravity Agent

-- 1. Shadow Profile Pattern Logic ([Section 2.2, 113])
/*
   [Shadow Profile Architecture]
   - Public-facing user data (Name, Bio, Avatar) lives in 'public.profiles'.
   - Auth/Login data (Email, Phone) lives in 'auth.users' (Supabase managed).
   - Foreign Key: profiles.id -> auth.users.id
   - Why? separation of concerns.
     - 'public.profiles' is readable by everyone (with RLS).
     - 'auth.users' is completely hidden.
   - Strategy:
     - On signup trigger -> Create 'public.profiles' entry immediately.
     - 'display_name' default = 'User-' + substr(uuid, 0, 5).
     - User updates 'display_name' later.
*/


-- 2. EAS Runtime Fingerprint Config ([Section 6.1, 472])
/*
   [Runtime Version Control]
   - In 'app.json':
     "runtimeVersion": {
       "policy": "fingerprint" 
     }
   - Meaning: "This OTA update is compatible ONLY if the native code hash matches exactly."
   - Prevents crashing users by sending JS that requires new Native Modules not present on their phone.
*/


-- 3. Geo-Routing Localization Header ([Section 1.2, 33])
/*
   [Geo-Context Injection]
   - Edge Function receives 'CF-IPCountry' (Cloudflare) or 'x-vercel-ip-country'.
   - Logic:
     const country = req.headers.get('cf-ipcountry') || 'US';
     // Inject into Supabase Context
     supabase.rpc('set_request_context', { country: country });
   - DB RLS Policy (e.g., specific content restrictions) can access this via:
     current_setting('request.context.country', true)
*/


-- 4. Unified Guard Middleware ([Section 1.2, 41])
-- Table to store valid Apple App Attest / Android Play Integrity tokens.

CREATE TABLE IF NOT EXISTS public.integrity_tokens (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    provider TEXT NOT NULL CHECK (provider IN ('apple', 'google')),
    token_hash TEXT NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for fast verification lookup
CREATE INDEX IF NOT EXISTS idx_integrity_tokens_hash ON public.integrity_tokens(token_hash);

-- Verification logic happens in Edge Function or Middleware.
-- This table is just the store for valid tokens to prevent replay attacks.


-- 5. Security search_path Hardening ([Section 4.2, 328])
-- The Nonuple Check. Rashisa Identity.
-- "Being Ourselves is the Best Security."

DO $$
DECLARE
    f record;
BEGIN
    FOR f IN SELECT proname FROM pg_proc JOIN pg_namespace ON pg_proc.pronamespace = pg_namespace.oid WHERE nspname = 'public' LOOP
        BEGIN
            EXECUTE format('ALTER FUNCTION public.%I SET search_path = public', f.proname);
        EXCEPTION WHEN OTHERS THEN NULL; END;
    END LOOP;
END $$;


-- [Final Declaration]
-- Dresaps Infrastructure - Rashisa Identity Complete. Being Ourselves is the Best Security.
