-- [DRESAPS V4.0] 01_Master_Structure.sql
-- Master Database Schema (DDL Only)
-- Generated by Antigravity Agent
-- Strict adherence to provided schema definition.

-- 1. Global Setup
-- 1.1 Timezone
ALTER DATABASE postgres SET timezone TO 'UTC';

-- 1.2 Extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_net";
CREATE EXTENSION IF NOT EXISTS "pg_cron";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- 1.3 Enums
DO $$ BEGIN
    CREATE TYPE public.user_role AS ENUM ('user', 'admin', 'gm');
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$;

DO $$ BEGIN
    CREATE TYPE public.job_status AS ENUM ('pending', 'processing', 'completed', 'failed', 'dead');
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$;

DO $$ BEGIN
    CREATE TYPE public.job_type AS ENUM ('image_generation', 'model_training', 'style_transfer');
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$;

DO $$ BEGIN
    CREATE TYPE public.item_category AS ENUM ('TOP', 'BOTTOM', 'SHOES', 'ACCESSORY', 'MASK', 'POSE', 'HAIR', 'FACE');
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$;

DO $$ BEGIN
    CREATE TYPE public.thermal_status AS ENUM ('GREEN', 'YELLOW', 'RED');
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$;


-- 2. User & Identity
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    display_name TEXT,
    role public.user_role DEFAULT 'user',
    reputation_score INT DEFAULT 100,
    birthdate DATE,
    follower_count INT DEFAULT 0,
    is_hell_gate_target BOOLEAN GENERATED ALWAYS AS (reputation_score < 75) STORED,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE INDEX IF NOT EXISTS idx_profiles_username_trgm ON public.profiles USING GIST (username gist_trgm_ops);


CREATE TABLE IF NOT EXISTS public.user_body_specs (
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE PRIMARY KEY,
    height_encrypted TEXT,
    weight_encrypted TEXT,
    scan_data_path TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.user_body_specs ENABLE ROW LEVEL SECURITY;


-- 3. Economy
CREATE TABLE IF NOT EXISTS public.wallets (
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE PRIMARY KEY,
    film_free BIGINT DEFAULT 0 CHECK (film_free >= 0),
    film_revenue BIGINT DEFAULT 0 CHECK (film_revenue >= 0),
    points BIGINT DEFAULT 0 CHECK (points >= 0),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.wallets ENABLE ROW LEVEL SECURITY;


CREATE TABLE IF NOT EXISTS public.transactions (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.wallets(user_id) ON DELETE CASCADE NOT NULL,
    amount BIGINT NOT NULL,
    currency_type TEXT NOT NULL CHECK (currency_type IN ('FILM_FREE', 'FILM_REV', 'POINT')),
    type TEXT NOT NULL CHECK (type IN ('DEPOSIT', 'WITHDRAWAL', 'REFUND')),
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.transactions ENABLE ROW LEVEL SECURITY;


-- 4. Wardrobe & Shop
CREATE TABLE IF NOT EXISTS public.items (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    category public.item_category NOT NULL,
    brand_name TEXT NOT NULL,
    price_film INT NOT NULL CHECK (price_film >= 0),
    is_active BOOLEAN DEFAULT TRUE,
    qty_limit INT,
    qty_sold INT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT check_qty_limit CHECK (qty_limit IS NULL OR qty_sold <= qty_limit)
);

ALTER TABLE public.items ENABLE ROW LEVEL SECURITY;


CREATE TABLE IF NOT EXISTS public.inventory (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    item_id UUID REFERENCES public.items(id) ON DELETE CASCADE NOT NULL,
    is_equipped BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT unique_inventory_item UNIQUE (user_id, item_id)
);

ALTER TABLE public.inventory ENABLE ROW LEVEL SECURITY;


-- 5. Social & Content
CREATE TABLE IF NOT EXISTS public.posts (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    storage_path TEXT NOT NULL,
    is_hidden BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
);

ALTER TABLE public.posts ENABLE ROW LEVEL SECURITY;


CREATE TABLE IF NOT EXISTS public.likes (
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    post_id UUID REFERENCES public.posts(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (user_id, post_id)
);

ALTER TABLE public.likes ENABLE ROW LEVEL SECURITY;


CREATE TABLE IF NOT EXISTS public.relationships (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    follower_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    following_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    status TEXT NOT NULL CHECK (status IN ('FOLLOW', 'BLOCK')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT unique_relationship UNIQUE (follower_id, following_id),
    CONSTRAINT no_self_follow CHECK (follower_id != following_id)
);

ALTER TABLE public.relationships ENABLE ROW LEVEL SECURITY;


-- 6. Gamification (Style Cup)
CREATE TABLE IF NOT EXISTS public.style_cup_matches (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    red_user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    blue_user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    winner_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    status TEXT NOT NULL CHECK (status IN ('ACTIVE', 'FINISHED')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.style_cup_matches ENABLE ROW LEVEL SECURITY;


CREATE TABLE IF NOT EXISTS public.style_cup_votes (
    match_id UUID REFERENCES public.style_cup_matches(id) ON DELETE CASCADE NOT NULL,
    voter_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    voted_user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (match_id, voter_id)
);

ALTER TABLE public.style_cup_votes ENABLE ROW LEVEL SECURITY;


-- 7. Infrastructure (Unified)
CREATE TABLE IF NOT EXISTS public.generation_jobs (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    job_type public.job_type NOT NULL,
    status public.job_status DEFAULT 'pending',
    priority INT DEFAULT 10,
    input_params JSONB NOT NULL DEFAULT '{}'::JSONB,
    worker_id UUID,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.generation_jobs ENABLE ROW LEVEL SECURITY;

CREATE INDEX IF NOT EXISTS idx_generation_jobs_input_params ON public.generation_jobs USING GIN (input_params);


CREATE TABLE IF NOT EXISTS public.admin_audit_logs (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    admin_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    action_type TEXT NOT NULL,
    target_id UUID,
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.admin_audit_logs ENABLE ROW LEVEL SECURITY;

CREATE INDEX IF NOT EXISTS idx_admin_audit_logs_metadata ON public.admin_audit_logs USING GIN (metadata);
