-- [DRESAPS V4.0] Absolute Integrity (Domain 13)
-- Section 2.2, 4.1, 4.2, 7.5
-- Generated by Antigravity Agent

-- 1. Crypto-Shredding Engine ([Section 2.2, 119])
-- Keys for encrypting sensitive user data. 
-- Deleting a row here effectively "shreds" all encrypted data for that user.

CREATE TABLE IF NOT EXISTS public.user_security_keys (
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE PRIMARY KEY,
    encryption_key TEXT NOT NULL, -- Stored encrypted by Supabase Vault ideally, but here as per schema req.
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.user_security_keys ENABLE ROW LEVEL SECURITY;
-- Only User can see their own key (Service Role can manage)
CREATE POLICY "User manage own keys" ON public.user_security_keys USING (auth.uid() = user_id);

-- [Crypto-Shredding Logic]
-- To delete user data permanently: DELETE FROM user_security_keys WHERE user_id = ?;
-- Without this key, 'user_measurements.encrypted_data' becomes garbage.


-- 2. Atomic Worker Fetch ([Section 4.1, 302])
-- High Performance Job Queue Fetcher.
CREATE OR REPLACE FUNCTION public.fetch_next_job(p_worker_id UUID)
RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
    v_job JSONB;
BEGIN
    -- Priority 1: High Priority Queue
    UPDATE public.jobs_high_priority
    SET status = 'processing', worker_id = p_worker_id, updated_at = NOW()
    WHERE id = (
        SELECT id FROM public.jobs_high_priority
        WHERE status = 'pending'
        ORDER BY created_at ASC
        FOR UPDATE SKIP LOCKED
        LIMIT 1
    )
    RETURNING to_jsonb(jobs_high_priority.*) INTO v_job;

    IF v_job IS NOT NULL THEN
        RETURN v_job;
    END IF;

    -- Priority 2: Normal Queue
    UPDATE public.jobs_normal
    SET status = 'processing', worker_id = p_worker_id, updated_at = NOW()
    WHERE id = (
        SELECT id FROM public.jobs_normal
        WHERE status = 'pending'
        ORDER BY created_at ASC
        FOR UPDATE SKIP LOCKED
        LIMIT 1
    )
    RETURNING to_jsonb(jobs_normal.*) INTO v_job;

    RETURN v_job; -- Returns Release if NULL
END;
$$;


-- 3. Security search_path ([Section 4.2, 328])
-- Re-defining critical triggers with explicit search_path.

CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS TRIGGER 
LANGUAGE plpgsql 
SECURITY DEFINER 
SET search_path = public -- [Section 4.2] Search Path Enforcement
AS $$
BEGIN
    INSERT INTO public.profiles (id, username, display_name, avatar_url, film_balance)
    VALUES (
        NEW.id,
        COALESCE(NEW.raw_user_meta_data->>'username', 'user_' || substr(NEW.id::text, 1, 8)),
        COALESCE(NEW.raw_user_meta_data->>'display_name', 'No Name'),
        NEW.raw_user_meta_data->>'avatar_url',
        0
    );
    RETURN NEW;
EXCEPTION WHEN OTHERS THEN
    RAISE EXCEPTION 'Profile Creation Failed: %', SQLERRM;
END;
$$;


-- 4. Budget Defense O(1) ([Section 4.2, 338])
-- Atomic Counter Increment.

CREATE OR REPLACE FUNCTION public.increment_api_counter(p_user_id UUID, p_key TEXT)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    INSERT INTO public.api_usage_counters (user_id, counter_key, count, last_updated)
    VALUES (p_user_id, p_key, 1, NOW())
    ON CONFLICT (user_id, counter_key)
    DO UPDATE SET 
        count = public.api_usage_counters.count + 1,
        last_updated = NOW();
END;
$$;


-- 5. Thermal Category Check ([Section 7.5, 574])
-- Reinforcing constraints.
DO $$ 
BEGIN
    -- Try to add constraint if it doesn't exist (Soft check via exception ignore or explicit check)
    BEGIN
        ALTER TABLE public.device_vitals 
        ADD CONSTRAINT thermal_status_check 
        CHECK (thermal_status IN ('GREEN', 'YELLOW', 'RED'));
    EXCEPTION WHEN duplicate_object THEN
        -- Constraint already exists
        NULL;
    END;
END $$;


-- 6. WORM Audit Ledger ([Section 7.5, 582])
-- Permanent Revoke.
REVOKE UPDATE, DELETE ON public.admin_audit_logs FROM public, authenticated, service_role;


-- 7. Main Engine Speed-up ([Section 2.2, 99])
-- Force External Storage for Content.
ALTER TABLE public.posts ALTER COLUMN content SET STORAGE EXTERNAL;


-- [Final Declaration]
-- Domain 13 Infrastructure Complete - Zero Dust.
