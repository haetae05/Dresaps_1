-- [DRESAPS V4.0] Core Logic Functions
-- Domain 13 Infrastructure & Security Compliance
-- Generated by Antigravity Agent

-- 0. Prerequisites
CREATE EXTENSION IF NOT EXISTS "pg_net";

-- 1. Ledger System [D-05]
-- Security Definer: Allows users to call this without having direct INSERT rights to film_ledger (if later revoked) 
-- or to encapsulate logic.

CREATE OR REPLACE FUNCTION public.deposit_film(
    p_user_id UUID,
    p_amount INT,
    p_reason TEXT
) 
RETURNS VOID 
LANGUAGE plpgsql 
SECURITY DEFINER 
AS $$
BEGIN
    -- [D-05] Validation: Positive amount only for deposit
    IF p_amount <= 0 THEN
        RAISE EXCEPTION 'Deposit amount must be positive';
    END IF;

    INSERT INTO public.film_ledger (user_id, amount, reason)
    VALUES (p_user_id, p_amount, p_reason);
END;
$$;

CREATE OR REPLACE FUNCTION public.withdraw_film(
    p_user_id UUID,
    p_amount INT,
    p_reason TEXT
) 
RETURNS VOID 
LANGUAGE plpgsql 
SECURITY DEFINER 
AS $$
DECLARE
    v_current_balance INT;
BEGIN
    -- [D-05] Validation: Positive amount for withdrawal logic (we subtract it later)
    IF p_amount <= 0 THEN
        RAISE EXCEPTION 'Withdrawal amount must be positive';
    END IF;

    -- [D-05] Check Balance (Atomic-ish read)
    SELECT COALESCE(SUM(amount), 0) INTO v_current_balance
    FROM public.film_ledger
    WHERE user_id = p_user_id;

    -- [D-05] Insufficient Funds Check
    IF v_current_balance < p_amount THEN
        RAISE EXCEPTION 'Insufficient Funds: Current % / Required %', v_current_balance, p_amount;
    END IF;

    -- [D-05] Append-Only: Insert negative value
    INSERT INTO public.film_ledger (user_id, amount, reason)
    VALUES (p_user_id, -p_amount, p_reason);
END;
$$;


-- 2. Auth Trigger: Automatic Profile Creation
-- Ensures every Auth user has a corresponding Public Profile.
CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS TRIGGER 
LANGUAGE plpgsql 
SECURITY DEFINER 
SET search_path = public 
AS $$
BEGIN
    INSERT INTO public.profiles (id, username, display_name, avatar_url)
    VALUES (
        new.id,
        new.raw_user_meta_data->>'username', -- Assumes metadata has username
        new.raw_user_meta_data->>'display_name',
        new.raw_user_meta_data->>'avatar_url'
    );
    RETURN new;
END;
$$;

-- Trigger Definition
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();


-- 3. Job Queue [C-03]
-- Invokes Edge Function when a new job is created.
-- Requires: pg_net extension and valid Edge Function URL.
CREATE OR REPLACE FUNCTION public.handle_job_created()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_function_url TEXT;
    v_request_id UUID;
BEGIN
    -- [C-04] Configuration Management
    -- In real prod, use Vault or specific config table. 
    -- For now, we assume a standard Supabase setup or placeholder.
    -- EDIT THIS URL AFTER DEPLOYMENT
    v_function_url := 'https://PROJECT_REF.supabase.co/functions/v1/worker-dispatcher';
    
    -- [C-03] Async Invocation via pg_net
    -- We fire and forget. The worker processes the job and updates status.
    SELECT net.http_post(
        url := v_function_url,
        headers := jsonb_build_object(
            'Content-Type', 'application/json'
        ),
        body := jsonb_build_object(
            'job_id', new.id,
            'job_type', new.job_type
        )
    ) INTO v_request_id;
    
    RETURN new;
END;
$$;

-- Trigger Definition
DROP TRIGGER IF EXISTS on_job_created ON public.generation_jobs;
CREATE TRIGGER on_job_created
AFTER INSERT ON public.generation_jobs
FOR EACH ROW EXECUTE FUNCTION public.handle_job_created();
