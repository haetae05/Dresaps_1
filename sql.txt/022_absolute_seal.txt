-- [DRESAPS V4.0] Absolute Seal (Domain 13)
-- Section 7.5, 1.1, 3.2, 6.4
-- Generated by Antigravity Agent

-- 1. Contra-Entry Audit Ledger ([Section 7.5, 581])
-- Reinforcing WORM nature.
REVOKE UPDATE, DELETE ON public.admin_audit_logs FROM public, authenticated, service_role;

-- [Operational Rule]
-- To correct an error in the ledger (e.g. wrong refund), DO NOT UPDATE the row.
-- INSERT a new row with action_type = 'CORRECTION' and reason referencing the original ID.
-- SELECT * FROM admin_audit_logs WHERE action_type = 'CORRECTION';


-- 2. Pre-computed UTC Standard ([Section 1.1, 10])
/*
   [DB Time Prohibition]
   - Usage of NOW(), CURRENT_TIMESTAMP, TIMEZONE() in business logic functions is BANNED.
   - All temporal logic must rely on 'p_now' (TIMESTAMPTZ) passed from the application/edge.
   - The Application Node is the Single Source of Truth for Time (NTP Sync).
*/


-- 3. Metadata Salting Strategy ([Section 3.2, 229])
/*
   [Storage Deduplication Bypass]
   - Problem: Cloud storage providers deduplicate files by hash, preventing redundant storage of the 'same' file.
   - Requirement: Steganography requires unique instances for unique metadata injection.
   - Solution: Append 1 random byte (Salt) to the end of the image binary BEFORE upload.
     This changes the file hash without affecting image rendering (PNG/JPEG ignores trailing garbage).
*/


-- 4. Structured Context Logging ([Section 6.4, 525])
-- A dedicated table for client-side error reporting with partial state snapshots.

CREATE TABLE IF NOT EXISTS public.client_error_logs (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    error_name TEXT NOT NULL,
    error_message TEXT NOT NULL,
    stack_trace TEXT,
    
    -- [Section 6.4] Context Snapshots
    breadcrumbs JSONB, -- Navigation history
    state_snapshot JSONB, -- Redux/Zustand slice relevant to error
    device_info JSONB, -- OS version, model
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS: Only INSERT allowed for authenticated users (or anon if needed, but risky)
ALTER TABLE public.client_error_logs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users report errors" ON public.client_error_logs FOR INSERT WITH CHECK (true);
-- No SELECT for public. Only Admins.


-- 5. Thermal & Memory Category ([Section 7.5, 574, 577])
-- Final Idempotent Check.

DO $$ 
BEGIN
    -- Memory Warning Count
    BEGIN
        ALTER TABLE public.device_vitals 
        ADD COLUMN memory_warning_count INT DEFAULT 0;
    EXCEPTION WHEN duplicate_column THEN
        NULL;
    END;

    -- Thermal Status Constraint
    BEGIN
        ALTER TABLE public.device_vitals 
        ADD CONSTRAINT thermal_status_check_seal 
        CHECK (thermal_status IN ('GREEN', 'YELLOW', 'RED'));
    EXCEPTION WHEN duplicate_object THEN
        NULL;
    END;
END $$;


-- [Final Declaration]
-- Dresaps Infrastructure - Total Body Scan Complete. Foundation 100.0% Hardened.
