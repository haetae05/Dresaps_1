-- [DRESAPS V4.0] Storage Policies (Domain 13)
-- Section 3. Storage & Assets Management
-- Generated by Antigravity Agent based on User Request

-- 1. Create Buckets [S-01]
-- We use INSERT ON CONFLICT to ensure idempotency.
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES
  ('avatars', 'avatars', true, 5242880, ARRAY['image/webp', 'image/jpeg', 'image/png']), -- 5MB
  ('posts', 'posts', true, 10485760, ARRAY['image/webp', 'image/jpeg', 'image/png']),   -- 10MB
  ('temp-raw', 'temp-raw', false, 20971520, ARRAY['image/webp', 'image/jpeg', 'image/png']), -- 20MB
  ('backups', 'backups', false, null, null) -- System Only
ON CONFLICT (id) DO UPDATE SET
  public = EXCLUDED.public,
  file_size_limit = EXCLUDED.file_size_limit,
  allowed_mime_types = EXCLUDED.allowed_mime_types;

-- 2. RLS Security Policies (Zero Trust) [D-04] & [S-03]
-- Ensure policies are applied to storage.objects

ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

-- (1) Public Read Access (Avatars & Posts)
DROP POLICY IF EXISTS "Public Access" ON storage.objects;
CREATE POLICY "Public Access" ON storage.objects FOR SELECT
USING ( bucket_id IN ('avatars', 'posts') );

-- (2) Authenticated Upload [S-03]
-- User can only upload to their own folder: bucket/uid/filename
DROP POLICY IF EXISTS "Auth Upload" ON storage.objects;
CREATE POLICY "Auth Upload" ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id IN ('avatars', 'posts', 'temp-raw')
  AND auth.role() = 'authenticated'
  AND (storage.foldername(name))[1] = auth.uid()::text 
);

-- (3) Owner Delete
-- User can only delete files in their own folder.
DROP POLICY IF EXISTS "Owner Delete" ON storage.objects;
CREATE POLICY "Owner Delete" ON storage.objects FOR DELETE
USING (
  bucket_id IN ('avatars', 'posts', 'temp-raw')
  AND auth.uid()::text = (storage.foldername(name))[1]
);

-- (4) Backups: No policy = Deny All (System only access via Service Role)
