-- [DRESAPS V4.0] 04_Master_Operation.sql
-- Master Operations (Cron, Maintenance, Performance Views)
-- Generated by Antigravity Agent
-- Strict adherence to operational requirements.

-- 0. Setup pg_cron
-- Ensure extension is active (Already in 01, but safe to repeat if idempotent)
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 1. Ranking Performance Fix (Materialized View) [Reg 1]
-- Real-time aggregation is expensive. We use a materialized view refreshed every 10 mins.

CREATE MATERIALIZED VIEW IF NOT EXISTS public.mat_ranking_weekly AS
SELECT
    p.id AS user_id,
    p.username,
    p.display_name,
    p.avatar_url,
    p.reputation_score,
    (
        (COALESCE(like_stats.total_likes, 0) * 1) +
        (COALESCE(win_stats.total_wins, 0) * 5)
    ) AS score,
    DENSE_RANK() OVER (ORDER BY (
        (COALESCE(like_stats.total_likes, 0) * 1) +
        (COALESCE(win_stats.total_wins, 0) * 5)
    ) DESC) AS rank,
    NOW() AS calculated_at
FROM public.profiles p
-- Join Likes (Received)
LEFT JOIN (
    SELECT p.user_id, COUNT(*) AS total_likes
    FROM public.posts p
    JOIN public.likes l ON p.id = l.post_id
    GROUP BY p.user_id
) like_stats ON p.id = like_stats.user_id
-- Join Style Cup Wins
LEFT JOIN (
    SELECT winner_id, COUNT(*) AS total_wins
    FROM public.style_cup_matches
    WHERE status = 'FINISHED' AND winner_id IS NOT NULL
    GROUP BY winner_id
) win_stats ON p.id = win_stats.winner_id
WHERE p.reputation_score >= 75 -- Hell Gate Filter
WITH DATA;

-- Performance Index
CREATE UNIQUE INDEX IF NOT EXISTS idx_mat_ranking_user ON public.mat_ranking_weekly(user_id);

-- Refresh Cron (Every 10 min)
SELECT cron.schedule('refresh_ranking', '*/10 * * * *', 'REFRESH MATERIALIZED VIEW CONCURRENTLY public.mat_ranking_weekly');


-- 2. Zombie Job Recovery (Fixing Stuck Workers) [Reg 2]
CREATE OR REPLACE FUNCTION public.recover_zombie_jobs()
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
    UPDATE public.generation_jobs
    SET status = 'pending',
        worker_id = NULL,
        updated_at = NOW()
    WHERE status = 'processing'
      AND updated_at < NOW() - INTERVAL '10 minutes';
END;
$$;

-- Cron (Every 5 min)
SELECT cron.schedule('recover_zombies', '*/5 * * * *', 'SELECT public.recover_zombie_jobs()');


-- 3. Storage Garbage Collection [Reg 3]
-- Function for Edge Function to consume (Delete from Queue)
-- We assume Edge Function deletes from S3, then calls this to acknowledge.
CREATE OR REPLACE FUNCTION public.cleanup_storage_queue_marker(
    p_ids UUID[]
)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
    DELETE FROM public.storage_delete_queue
    WHERE id = ANY(p_ids);
END;
$$;

-- Maintenance Cron: Delete old Audit Logs (> 1 Year)
-- Run daily at 03:00 UTC
SELECT cron.schedule('cleanup_audit_logs', '0 3 * * *', 'DELETE FROM public.admin_audit_logs WHERE created_at < NOW() - INTERVAL ''1 year''');


-- 4. Season Management [Reg 4]
-- Table for History
CREATE TABLE IF NOT EXISTS public.season_history (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    season_date DATE NOT NULL, -- The 1st of the month
    user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    rank INT,
    score INT,
    snapshot_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.season_history ENABLE ROW LEVEL SECURITY;
-- Public Read for Hall of Fame
CREATE POLICY "Public view season history" ON public.season_history FOR SELECT USING (true);
-- System Write Only (No inserts for auth)

-- Snapshot Function
CREATE OR REPLACE FUNCTION public.snapshot_season_ranking()
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
    -- Snapshot Top 100 from Materialized View
    INSERT INTO public.season_history (season_date, user_id, rank, score)
    SELECT 
        CURRENT_DATE, -- Today (1st of month)
        user_id,
        rank,
        score
    FROM public.mat_ranking_weekly
    WHERE rank <= 100;

    -- (Optional) Reset Logic here if Score is cumulative per season
    -- Assuming current requirements are Snapshot Only.
END;
$$;

-- Cron (Monthly 1st at 00:00)
SELECT cron.schedule('snapshot_season', '0 0 1 * *', 'SELECT public.snapshot_season_ranking()');


-- 5. Database Maintenance (Self-Healing) [Reg 5]
-- Vacuum High Churn Tables (Daily 04:00 UTC)
SELECT cron.schedule('vacuum_maintenance', '0 4 * * *', 'VACUUM ANALYZE public.generation_jobs; VACUUM ANALYZE public.wallets;');

-- Grant Permissions to postgres (default cron user)
GRANT USAGE ON SCHEMA public TO postgres;
GRANT ALL ON ALL TABLES IN SCHEMA public TO postgres;
