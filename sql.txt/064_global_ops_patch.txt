-- [DRESAPS V4.0] Global Operations Patch (Domain 12 & 14)
-- Generated by Antigravity Agent

-- 1. [D-02] Reputation Reset & Schema (Default 100)
/*
   [Fresh Start Policy]
   - All users start with 100 Reputation.
   - Retroactive fix for 0/NULL/50 scores.
*/
ALTER TABLE public.profiles ALTER COLUMN reputation_score SET DEFAULT 100;

UPDATE public.profiles
SET reputation_score = 100
WHERE reputation_score IS NULL OR reputation_score = 0 OR reputation_score = 50;


-- 2. [D-12] Hell Gate Policy (75 Point Threshold)
/*
   [Stricter Standards]
   - < 75: Critical (Hell Gate)
   - 75-79: Danger (Shadow Ban)
   - 80-89: Warning
   - 90+: Normal
*/

-- Computed Column (Idempotent)
ALTER TABLE public.profiles
ADD COLUMN IF NOT EXISTS is_hell_gate_target BOOLEAN
GENERATED ALWAYS AS (reputation_score < 75) STORED;

-- Status Trigger Function (Override)
CREATE OR REPLACE FUNCTION public.handle_reputation_change()
RETURNS TRIGGER LANGUAGE plpgsql AS $$
BEGIN
    -- [Domain 12] Standardized Thresholds
    IF NEW.reputation_score < 75 THEN
        NEW.status := 'CRITICAL'; -- Hell Gate (Visible Penalty)
    ELSIF NEW.reputation_score < 80 THEN
        NEW.status := 'DANGER'; -- Shadow Ban (Ghost Protocol)
    ELSIF NEW.reputation_score < 90 THEN
        NEW.status := 'WARNING'; -- Restrictions
    ELSE
        NEW.status := 'NORMAL';
    END IF;
    
    RETURN NEW;
END;
$$;

-- Trigger Re-attachment
DROP TRIGGER IF EXISTS trg_reputation_change ON public.profiles;
CREATE TRIGGER trg_reputation_change
BEFORE INSERT OR UPDATE OF reputation_score ON public.profiles
FOR EACH ROW EXECUTE FUNCTION public.handle_reputation_change();


-- 3. [D-12] Ghost Protocol (Shadow Ban Mechanics)
/*
   [Invisibility Cloak]
   - Posts/Comments from Danger/Critical users are hidden.
   - Author sees them, others don't.
*/

-- Schema
ALTER TABLE public.posts ADD COLUMN IF NOT EXISTS is_hidden BOOLEAN DEFAULT FALSE;
ALTER TABLE public.comments ADD COLUMN IF NOT EXISTS is_hidden BOOLEAN DEFAULT FALSE;

-- Trigger Function
CREATE OR REPLACE FUNCTION public.enforce_ghost_protocol()
RETURNS TRIGGER LANGUAGE plpgsql AS $$
DECLARE
    user_score INT;
BEGIN
    SELECT reputation_score INTO user_score FROM public.profiles WHERE id = NEW.user_id;

    -- [Threshold] < 75 Critical -> Hidden
    -- [Requirement Update] User said < 75, but DANGER (75-79) is also Shadow Ban in definitions.
    -- Assuming stricter rule: If status is Critical or Danger (< 80), hiding is safer.
    -- However, prompt Requirement 3 explicitly says: "작성자의 점수가 75점 미만이면 NEW.is_hidden := TRUE"
    -- I will follow Requirement 3 strictly.
    
    IF user_score < 75 THEN
        NEW.is_hidden := TRUE;
    END IF;
    
    RETURN NEW;
END;
$$;

-- Triggers
DROP TRIGGER IF EXISTS trg_ghost_posts ON public.posts;
CREATE TRIGGER trg_ghost_posts
BEFORE INSERT ON public.posts
FOR EACH ROW EXECUTE FUNCTION public.enforce_ghost_protocol();

DROP TRIGGER IF EXISTS trg_ghost_comments ON public.comments;
CREATE TRIGGER trg_ghost_comments
BEFORE INSERT ON public.comments
FOR EACH ROW EXECUTE FUNCTION public.enforce_ghost_protocol();

-- RLS Policy Replacement (The "Ghost" View)
DROP POLICY IF EXISTS "Public View Posts" ON public.posts;
CREATE POLICY "Public View Posts" ON public.posts
FOR SELECT USING (
    (is_hidden = FALSE) OR (auth.uid() = user_id)
);

DROP POLICY IF EXISTS "Public View Comments" ON public.comments;
CREATE POLICY "Public View Comments" ON public.comments
FOR SELECT USING (
    (is_hidden = FALSE) OR (auth.uid() = user_id)
);


-- 4. [D-14] Global Infrastructure (Universal Time & Assets)
/*
   [Global Standard]
   - UTC Database Time.
   - User Timezone & Language support.
   - Bucket configurations.
*/

-- DB Timezone
-- (Wrapped in DO block just in case of permission issues in some environments, though 'postgres' user usually can)
DO $$ BEGIN
    EXECUTE 'ALTER DATABASE postgres SET timezone TO ''UTC''';
EXCEPTION WHEN OTHERS THEN
    NULL; -- Skip if not superuser / not allowed
END $$;

-- Profile Localization
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS timezone TEXT DEFAULT 'UTC';
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS language_code TEXT DEFAULT 'en';

-- Buckets (Idempotent)
INSERT INTO storage.buckets (id, name, public) VALUES ('static-assets', 'static-assets', TRUE) ON CONFLICT (id) DO NOTHING;
INSERT INTO storage.buckets (id, name, public) VALUES ('evidence_archive', 'evidence_archive', FALSE) ON CONFLICT (id) DO NOTHING;

-- [Final Declaration]
-- Dresaps Infrastructure - Global Ops Patch Applied. Reputation & Security Policies Enforced.
