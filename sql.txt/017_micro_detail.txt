-- [DRESAPS V4.0] Micro Detail (Domain 13)
-- Section 2.2, 2.1, 3.2, 7.5
-- Generated by Antigravity Agent

-- 1. TOAST Optimization ([Section 2.2, 99])
-- Ensuring large columns are stored externally to keep the main heap small.
-- (Reinforcing previous steps or applying to new candidates if any).

ALTER TABLE public.posts ALTER COLUMN content SET STORAGE EXTERNAL;
ALTER TABLE public.profiles ALTER COLUMN bio SET STORAGE EXTERNAL;
-- New candidate: JSONB payloads can be large
ALTER TABLE public.generation_jobs ALTER COLUMN input_params SET STORAGE EXTERNAL;
ALTER TABLE public.generation_jobs ALTER COLUMN result_data SET STORAGE EXTERNAL;


-- 2. Jitter & Retry Strategy ([Section 2.1, 87])
-- [Database Guide for Edge Functions & Clients]
/*
   Retry Logic Specification:
   - Base Delay: 500ms
   - Max Retries: 3
   - Algorithm: Exponential Backoff with Jitter
     Sleep = min(Cap, Base * 2^Attempt) + Random(0, 100ms)
   
   This prevents "Thundering Herd" problem during DB recovery.
   ALL Edge Functions MUST implement this standard.
*/


-- 3. Metadata Salting Policy ([Section 3.2, 229])
-- [Storage Guide]
/*
   File Upload Salting:
   - Supabase usually dedups by filename.
   - To force unique storage even for identical files (privacy/steganography):
     Add 1 random byte (Salt) to the end of the file or use a unique path.
     path = `${user_id}/${uuid_v4()}/${filename}`
   - Do NOT rely on filename alone.
*/


-- 4. Thermal Grade Constraint ([Section 7.5, 574])
-- Reinforcing the constraint again just to be absolutely sure.
-- Using DO block to handle "already exists" without error.

DO $$ 
BEGIN
    BEGIN
        ALTER TABLE public.device_vitals 
        ADD CONSTRAINT thermal_status_check_final 
        CHECK (thermal_status IN ('GREEN', 'YELLOW', 'RED'));
    EXCEPTION WHEN duplicate_object THEN
        NULL;
    END;
END $$;


-- 5. Blueprint Storage Logic ([Section 3.2, 245])
-- A registry to track which user has which blueprint (stego-data).
-- Distinct from 'blueprint_metadata' which stores the actual data chunks.
-- This registry maps User <-> Blueprint access rights or discovery.

CREATE TABLE IF NOT EXISTS public.blueprint_registry (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    blueprint_id TEXT NOT NULL, -- e.g. "BP-001-ALPHA"
    acquired_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Constraint: User can only have one copy of a specific blueprint? 
    -- Or just unique tracking.
    UNIQUE(user_id, blueprint_id)
);

ALTER TABLE public.blueprint_registry ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users view own blueprints" 
ON public.blueprint_registry 
FOR SELECT 
USING (auth.uid() = user_id);

-- Only System inserts (Discovery logic)
-- But we can allow insert if there's a specific logic, usually System.
-- We'll keep it System/Admin strict or via function.


-- [Final Declaration]
-- Dresaps Micro-Detail Completion - The 'Apple Pie' Spirit.
