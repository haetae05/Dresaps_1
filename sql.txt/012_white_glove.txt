-- [DRESAPS V4.0] White Glove (Domain 13)
-- Section 5.3 Self Healing, 2.2 Storage Optimization, 5.1 Cron Safety
-- Generated by Antigravity Agent

-- 1. Storage Optimization ([Section 2.2, 99])
-- Force large text columns to be stored externally (TOAST) to keep main table pages small and fast.
-- Use ONLY for columns accessed infrequently or large payloads.

ALTER TABLE public.posts ALTER COLUMN content SET STORAGE EXTERNAL;
ALTER TABLE public.profiles ALTER COLUMN bio SET STORAGE EXTERNAL;


-- 2. Cron Collision Protection ([Section 5.1, 396])
-- Preventing overlapping jobs using Advisory Transaction Locks.
-- We replace the 'run_cron_job' function from 004/005 with this safer version.

CREATE OR REPLACE FUNCTION public.run_cron_job(p_job_name TEXT, p_sql TEXT)
RETURNS VOID
LANGUAGE plpgsql
AS $$
DECLARE
    v_lock_id BIGINT;
BEGIN
    -- [Section 5.1] Generate unique lock ID from job name
    v_lock_id := hashtext(p_job_name);
    
    -- [Section 5.1] Try to acquire lock. If false, someone else is running it.
    IF pg_try_advisory_xact_lock(v_lock_id) THEN
        BEGIN
            EXECUTE p_sql;
            INSERT INTO public.cron_audit_logs (job_name, status, message) 
            VALUES (p_job_name, 'success', 'Executed successfully');
        EXCEPTION WHEN OTHERS THEN
            INSERT INTO public.cron_audit_logs (job_name, status, message) 
            VALUES (p_job_name, 'error', SQLERRM);
        END;
    ELSE
        -- [Section 5.1] Overlap detected
        INSERT INTO public.cron_audit_logs (job_name, status, message) 
        VALUES (p_job_name, 'skipped', 'Skipping overlapping job (Lock held)');
    END IF;
END;
$$;


-- 3. Database Self-Healing ([Section 5.3, 430])
-- Aggressive Vacuuming for high-churn tables to prevent bloat.
-- Setting scale factor to 0.05 (5%) ensures frequent cleanup.

ALTER TABLE public.profiles SET (autovacuum_vacuum_scale_factor = 0.05);
ALTER TABLE public.posts SET (autovacuum_vacuum_scale_factor = 0.05);
-- Split jobs tables
ALTER TABLE public.jobs_high_priority SET (autovacuum_vacuum_scale_factor = 0.05);
ALTER TABLE public.jobs_normal SET (autovacuum_vacuum_scale_factor = 0.05);
-- Deprecated table cleanup just in case
ALTER TABLE public.generation_jobs_deprecated SET (autovacuum_vacuum_scale_factor = 0.05);


-- 4. Network Standard ([Section 1.1, 15])
/*
   [Final Network Compliance Check]
   All Edge Functions MUST include:
   
   headers: {
     "Content-Encoding": "br", // [cite: 16] Brotli
     "Cache-Control": "public, max-age=3600"
   }
   
   This ensures Domain 13 Network Acceleration compliance.
*/

-- [Final Declaration]
-- Domain 13 Infrastructure Construction Completed.
-- 000 to 012.
-- Ready for Phase 2.
