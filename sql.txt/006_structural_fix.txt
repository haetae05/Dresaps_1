-- [DRESAPS V4.0] Structural Fixes (Domain 13)
-- Addressing Structural Gaps: Priority Queues, Crypto Keys, Metadata
-- Generated by Antigravity Agent

-- 1. Priority Queue Splitting [C-03]
-- Replacing single 'generation_jobs' with physical separation for VIPs.

-- Rename old table if exists to backup (or drop if empty/dev)
ALTER TABLE IF EXISTS public.generation_jobs RENAME TO generation_jobs_deprecated;

-- (A) High Priority Table (VIP)
CREATE TABLE public.jobs_high_priority (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    job_type TEXT NOT NULL,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'dead')),
    input_params JSONB NOT NULL,
    worker_id UUID,
    result_data JSONB,
    priority_score INT DEFAULT 100, -- VIP Weights
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- (B) Normal Priority Table
CREATE TABLE public.jobs_normal (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    job_type TEXT NOT NULL,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'dead')),
    input_params JSONB NOT NULL,
    worker_id UUID,
    result_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS for Job Tables
ALTER TABLE public.jobs_high_priority ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.jobs_normal ENABLE ROW LEVEL SECURITY;

CREATE POLICY "VIPs view own jobs" ON public.jobs_high_priority FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users view own jobs" ON public.jobs_normal FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "VIPs insert jobs" ON public.jobs_high_priority FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users insert jobs" ON public.jobs_normal FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Indexes for Workers [C-03]
CREATE INDEX idx_jobs_high_pending ON public.jobs_high_priority (created_at) WHERE status = 'pending';
CREATE INDEX idx_jobs_normal_pending ON public.jobs_normal (created_at) WHERE status = 'pending';


-- 2. Crypto-Shredding Key Store [D-03]
-- Stores Per-User Encryption Keys. Deleting a row here effectively shreds all encrypted user data.
CREATE TABLE public.user_security_keys (
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    encryption_key TEXT NOT NULL, -- In prod, this might be wrapped/encrypted by a Master Key
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.user_security_keys ENABLE ROW LEVEL SECURITY;

-- Strict Privacy: Only the user custom access
-- ADMIN CANNOT SELECT.
CREATE POLICY "User manage own keys" 
ON public.user_security_keys 
FOR ALL 
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);


-- 3. Image Metadata Store [S-06]
-- Preserves EXIF/Camera data decoupled from the main post.
CREATE TABLE public.image_meta (
    image_id UUID REFERENCES public.posts(id) ON DELETE CASCADE PRIMARY KEY,
    exif_data JSONB,
    camera_model TEXT,
    lens_info TEXT,
    captured_at TIMESTAMPTZ
);

ALTER TABLE public.image_meta ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public read meta" ON public.image_meta FOR SELECT USING (true);
CREATE POLICY "User write meta" ON public.image_meta FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM public.posts WHERE id = image_id AND user_id = auth.uid())
);


-- 4. Safety Rule [D-05]
-- Re-applying/Ensuring Soft Delete Rule exists.
CREATE OR REPLACE RULE protect_posts_delete AS
ON DELETE TO public.posts
DO INSTEAD
UPDATE public.posts
SET deleted_at = NOW()
WHERE id = OLD.id AND deleted_at IS NULL;
