-- [DRESAPS V4.0] Reinforcement (Domain 13)
-- Section 2.2 Ledger & Section 4.2 Hardened Triggers
-- Generated by Antigravity Agent

-- 1. Append-Only Ledger ([D-05])
-- Ensure film_ledger exists (Created in 000, ensuring structure)
CREATE TABLE IF NOT EXISTS public.film_ledger (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    amount INT NOT NULL CHECK (amount != 0),
    reason TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Access Control (RLS) if newly created or ensuring security
ALTER TABLE public.film_ledger ENABLE ROW LEVEL SECURITY;
REVOKE UPDATE, DELETE ON public.film_ledger FROM public, authenticated, service_role;

-- [D-05] Balance View
CREATE OR REPLACE VIEW public.v_user_film_balance AS
SELECT 
    user_id,
    COALESCE(SUM(amount), 0) as balance
FROM 
    public.film_ledger
GROUP BY 
    user_id;

-- Grant access to View
GRANT SELECT ON public.v_user_film_balance TO authenticated, service_role;


-- 2. Profile Security Hardening

-- Ensure film_balance column exists to Apply Permissions
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS film_balance INT DEFAULT 0;

-- [D-05] REVOKE UPDATE on film_balance
-- Even if user can update their bio, they CANNOT update their film_balance.
-- It must be updated by System Triggers or Functions only (if cached), 
-- or simply ignored in favor of the View.
REVOKE UPDATE (film_balance) ON public.profiles FROM public, authenticated;


-- 3. Hardened Auth Trigger ([Section 4.2])
-- Replaces previous implementation with stricter security controls.

CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS TRIGGER 
LANGUAGE plpgsql 
SECURITY DEFINER 
SET search_path = public -- [Section 4.2] Prevent Search Path Hijacking
AS $$
BEGIN
    INSERT INTO public.profiles (id, username, display_name, avatar_url, film_balance)
    VALUES (
        NEW.id,
        COALESCE(NEW.raw_user_meta_data->>'username', 'user_' || substr(NEW.id::text, 1, 8)),
        COALESCE(NEW.raw_user_meta_data->>'display_name', 'No Name'),
        NEW.raw_user_meta_data->>'avatar_url',
        0 -- Initial Balance
    );
    RETURN NEW;
EXCEPTION WHEN OTHERS THEN
    -- [Section 4.2] Rollback Transaction on Failure
    -- Logs error and re-raises to ensure Auth User creation is also rolled back.
    RAISE EXCEPTION 'Failed to create profile for user %: %', NEW.id, SQLERRM;
END;
$$;

-- Ensure Trigger is active
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
