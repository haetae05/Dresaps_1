-- [DRESAPS V4.0] 072_seed_simulation.sql
-- Seed & Simulation Script
-- Generated by Antigravity Agent

DO $$
DECLARE
    -- Mock IDs
    v_rich_id UUID;
    v_poor_id UUID;
    v_bad_id UUID;
    v_item_hoodie UUID;
    v_item_tee UUID;
    v_report_id UUID;
    v_rep_score INT;
    v_user_exists BOOLEAN;
BEGIN
    RAISE NOTICE '--- START SEED SIMULATION: 072 ---';

    -- 1. Setup Items (Master Data)
    -- Insert only if not exists (Idempotency)
    INSERT INTO public.items (category, brand_name, price_points, rarity, metadata)
    VALUES
        ('TOP', 'Basic Tee', 100, 'COMMON', '{"color":"white"}'),
        ('BOTTOM', 'Jeans', 200, 'COMMON', '{"color":"blue"}'),
        ('TOP', 'Hoodie', 5000, 'RARE', '{"color":"black"}')
    ON CONFLICT DO NOTHING;

    -- Retrieve ID for test
    SELECT id INTO v_item_hoodie FROM public.items WHERE brand_name = 'Hoodie' LIMIT 1;
    SELECT id INTO v_item_tee FROM public.items WHERE brand_name = 'Basic Tee' LIMIT 1;

    -- 2. User Simulation (Create 3 Users)
    -- We check if they exist first to avoid constraint errors on re-run
    
    -- User Rich
    SELECT id INTO v_rich_id FROM auth.users WHERE email = 'rich@test.com';
    IF v_rich_id IS NULL THEN
        v_rich_id := gen_random_uuid();
        INSERT INTO auth.users (id, email, encrypted_password, email_confirmed_at, aud, role)
        VALUES (v_rich_id, 'rich@test.com', '$2a$10$mic...', NOW(), 'authenticated', 'authenticated');
    END IF;

    -- User Poor
    SELECT id INTO v_poor_id FROM auth.users WHERE email = 'poor@test.com';
    IF v_poor_id IS NULL THEN
        v_poor_id := gen_random_uuid();
        INSERT INTO auth.users (id, email, encrypted_password, email_confirmed_at, aud, role)
        VALUES (v_poor_id, 'poor@test.com', '$2a$10$mic...', NOW(), 'authenticated', 'authenticated');
    END IF;

    -- User Bad
    SELECT id INTO v_bad_id FROM auth.users WHERE email = 'bad@test.com';
    IF v_bad_id IS NULL THEN
        v_bad_id := gen_random_uuid();
        INSERT INTO auth.users (id, email, encrypted_password, email_confirmed_at, aud, role)
        VALUES (v_bad_id, 'bad@test.com', '$2a$10$mic...', NOW(), 'authenticated', 'authenticated');
        
        -- Force Reputation Reset (for re-run consistency)
        UPDATE public.profiles SET reputation_score = 100 WHERE id = v_bad_id;
    END IF;

    -- 3. Economy Action (Give Money)
    -- Rich: +100,000
    -- Poor: +500
    PERFORM public.process_transaction(v_rich_id, 100000, 'POINT', 'DEPOSIT', 'Seed Money - Rich');
    PERFORM public.process_transaction(v_poor_id, 500, 'POINT', 'DEPOSIT', 'Seed Money - Poor');


    -- 4. Commerce Action (Purchase)
    -- Mock Auth Context: Switch to Rich
    -- We assume function is SECURITY DEFINER but calls auth.uid() for validation.
    -- (If purchase_item checks auth.uid(), we must set it. If we run as superuser, RLS bypassed but check remains)
    -- Trick: Set config for request.jwt.claim.sub
    
    PERFORM set_config('request.jwt.claim.sub', v_rich_id::text, true);
    
    -- Rich Buys Hoodie (5000)
    -- Only buy if not owned
    IF NOT EXISTS (SELECT 1 FROM public.inventory WHERE user_id = v_rich_id AND item_id = v_item_hoodie) THEN
        PERFORM public.purchase_item(v_item_hoodie, 'POINT');
        RAISE NOTICE 'Rich purchased Hoodie.';
    END IF;

    -- Mock Auth Context: Switch to Poor
    PERFORM set_config('request.jwt.claim.sub', v_poor_id::text, true);
    
    -- Poor Tries to Buy Hoodie (5000, Has 500) -> Fail
    BEGIN
        PERFORM public.purchase_item(v_item_hoodie, 'POINT');
        RAISE EXCEPTION 'Poor purchased Hoodie despite insufficient funds!';
    EXCEPTION WHEN OTHERS THEN
        RAISE NOTICE 'Poor purchase blocked correctly: %', SQLERRM;
    END;


    -- 5. Social Action
    -- Reset Context for Insert RLS
    
    -- Rich Posts
    PERFORM set_config('request.jwt.claim.sub', v_rich_id::text, true);
    INSERT INTO public.posts (user_id, storage_path, content) 
    VALUES (v_rich_id, 'seed/rich1', 'My First Rich Post')
    RETURNING id INTO v_report_id; -- Reuse variable just to suppress output

    -- Bad Posts
    PERFORM set_config('request.jwt.claim.sub', v_bad_id::text, true);
    INSERT INTO public.posts (user_id, storage_path, content)
    VALUES (v_bad_id, 'seed/bad1', 'SPAM SPAM SPAM');

    -- Poor Follows Rich
    PERFORM set_config('request.jwt.claim.sub', v_poor_id::text, true);
    INSERT INTO public.relationships (follower_id, following_id, status)
    VALUES (v_poor_id, v_rich_id, 'FOLLOW')
    ON CONFLICT DO NOTHING;


    -- 6. Admin Action (Report & Punish)
    
    -- Rich Reports Bad
    PERFORM set_config('request.jwt.claim.sub', v_rich_id::text, true);
    INSERT INTO public.reports (reporter_id, target_user_id, reason)
    VALUES (v_rich_id, v_bad_id, 'SPAM CONTENT')
    ON CONFLICT (reporter_id, target_user_id) DO UPDATE SET reason = 'SPAM RE-REPORT'
    RETURNING id INTO v_report_id;

    -- Admin (System) Resolves
    -- Switch to System (Null or Admin ID)
    PERFORM set_config('request.jwt.claim.sub', NULL, true);
    
    -- Deduct 30 Points (100 -> 70)
    PERFORM public.resolve_report(v_report_id, 'RESOLVED', 30);
    
    -- Verify Hell Gate
    SELECT reputation_score INTO v_rep_score FROM public.profiles WHERE id = v_bad_id;
    
    IF v_rep_score < 75 THEN
        RAISE NOTICE 'Hell Gate Verified: Limit 75, Current %', v_rep_score;
    ELSE
        RAISE EXCEPTION 'Hell Gate Logic Failed! Score: %', v_rep_score;
    END IF;

    RAISE NOTICE '--- SEED SIMULATION COMPLETED SUCCESSFULLY ---';
END $$;
