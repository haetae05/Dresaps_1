-- [DRESAPS V4.0] Final Wiring (Domain 13)
-- Trigger Re-wiring & Audit Logging
-- Generated by Antigravity Agent

-- 1. Trigger Re-wiring ([C-03])
-- We split 'generation_jobs' into 'jobs_high_priority' and 'jobs_normal'.
-- We must attach the 'invoke_worker' (handle_job_created) trigger to both.

-- Drop trigger from global/deprecated table if exists
DROP TRIGGER IF EXISTS on_job_created ON public.generation_jobs;
DROP TRIGGER IF EXISTS on_job_created ON public.generation_jobs_deprecated;

-- A. Wire High Priority Table
DROP TRIGGER IF EXISTS on_vip_job_created ON public.jobs_high_priority;
CREATE TRIGGER on_vip_job_created
AFTER INSERT ON public.jobs_high_priority
FOR EACH ROW EXECUTE FUNCTION public.handle_job_created();

-- B. Wire Normal Priority Table
DROP TRIGGER IF EXISTS on_normal_job_created ON public.jobs_normal;
CREATE TRIGGER on_normal_job_created
AFTER INSERT ON public.jobs_normal
FOR EACH ROW EXECUTE FUNCTION public.handle_job_created();


-- 2. Audit Logs ([O-02])
-- Immutable log of admin actions.

CREATE TABLE IF NOT EXISTS public.admin_audit_logs (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    admin_id UUID REFERENCES auth.users(id),
    action_type TEXT NOT NULL, -- e.g. 'ban_user', 'refund_film', 'delete_post'
    target_id UUID, -- Affected User ID or Resource ID
    reason TEXT,
    meta_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS: Strict Append-Only
ALTER TABLE public.admin_audit_logs ENABLE ROW LEVEL SECURITY;

-- Admins can INSERT logs (Self-audit)
CREATE POLICY "Admins insert logs" 
ON public.admin_audit_logs 
FOR INSERT 
WITH CHECK (
    -- Verify the inserting user is an admin
    EXISTS (
        SELECT 1 FROM public.profiles 
        WHERE id = auth.uid() AND role IN ('admin', 'gm')
    )
    AND auth.uid() = admin_id
);

-- Admins can VIEW logs
CREATE POLICY "Admins view logs" 
ON public.admin_audit_logs 
FOR SELECT 
USING (
    EXISTS (
        SELECT 1 FROM public.profiles 
        WHERE id = auth.uid() AND role IN ('admin', 'gm')
    )
);

-- UPDATE/DELETE is implicitly DENIED for everyone (No policy created).
-- This ensures 'Non-Repudiation' (부인 방지).
