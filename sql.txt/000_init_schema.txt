-- [DRESAPS V4.0] Initial Schema Definition
-- Domain 13 Infrastructure & Security Compliance
-- Generated by Antigravity Agent

-- 1. Setup Extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 2. Domain 02 & 07: Profiles (Shadow Profile Pattern [D-07])
-- User identity is strictly separated from Auth. Users cannot change ID.
CREATE TABLE public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY, -- [D-07] Auth ID binding
    username TEXT UNIQUE NOT NULL, -- [D-07] Immutable Service ID
    display_name TEXT,
    bio TEXT,
    avatar_url TEXT,
    role TEXT DEFAULT 'user' CHECK (role IN ('user', 'admin', 'gm')),
    reputation INT DEFAULT 100, -- Domain 12 Reputation
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS: Profiles
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Policy: Public Read
CREATE POLICY "Public profiles are viewable by everyone" 
ON public.profiles FOR SELECT USING (true);

-- Policy: User Update (Own Profile)
CREATE POLICY "Users can insert their own profile" 
ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile" 
ON public.profiles FOR UPDATE USING (auth.uid() = id);

-- 3. Domain 13 (D-04/D-10): User Measurements (Privacy Vault)
-- [D-10] Client E2E Encryption mandated conceptually.
-- [D-04] Security Definer / RLS: Only the user can see this. ADMINS CANNOT SEE.
CREATE TABLE public.user_measurements (
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE PRIMARY KEY,
    height_cm NUMERIC(5,2),
    weight_kg NUMERIC(5,2),
    shoulder_cm NUMERIC(5,2),
    chest_cm NUMERIC(5,2),
    waist_cm NUMERIC(5,2),
    hip_cm NUMERIC(5,2),
    leg_cm NUMERIC(5,2),
    encrypted_data TEXT, -- [D-10] Encrypted payload for extra security
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS: Measurements
ALTER TABLE public.user_measurements ENABLE ROW LEVEL SECURITY;

-- [D-10] Strict Privacy: Only owner can SELECT
CREATE POLICY "Strict Privacy: Owner only" 
ON public.user_measurements 
FOR ALL 
USING (auth.uid() = user_id);

-- 4. Domain 07: Film Ledger (Append-Only Economy [D-05])
-- [D-05] Append-Only Ledger: Balance is never updated, only INSERT allowed.
CREATE TABLE public.film_ledger (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    amount INT NOT NULL CHECK (amount != 0), -- Positive for earn, Negative for spend
    reason TEXT NOT NULL,
    reference_id UUID, -- For linking to posts/jobs
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS: Ledger
ALTER TABLE public.film_ledger ENABLE ROW LEVEL SECURITY;

-- [D-05] Immutable: No UPDATE/DELETE allowed for anyone
REVOKE UPDATE, DELETE ON public.film_ledger FROM public, authenticated, service_role;

-- Policy: Users can see their own ledger
CREATE POLICY "Users view own ledger" 
ON public.film_ledger FOR SELECT USING (auth.uid() = user_id);

-- [D-05] System/Server inserts only (via Service Role usually)
-- But for RLS compatibility, if client inserts, they can only insert for themselves
-- However, typically economy is handled by Edge Functions (Service Role).
-- We allow INSERT for auth users for now (e.g. daily login claim) but Logic layer must guard.
CREATE POLICY "Users/System insert ledger" 
ON public.film_ledger FOR INSERT WITH CHECK (auth.uid() = user_id);


-- 5. Domain 04: Posts (WORM Storage [S-03])
-- Content is immutable once posted.
CREATE TABLE public.posts (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    storage_path TEXT NOT NULL, -- [S-03] WORM Path
    content TEXT, -- Caption or Metadata
    meta_json JSONB, -- [S-06] Sidecar Metadata
    likes_count INT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()  -- [S-03] Immutable Timestamp
);

ALTER TABLE public.posts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public view posts" 
ON public.posts FOR SELECT USING (true);

-- [S-03] Write Once: INSERT only. UPDATE restricted by app logic or rigid policy.
CREATE POLICY "Users create posts" 
ON public.posts FOR INSERT WITH CHECK (auth.uid() = user_id);

-- 6. Domain 13: Generation Jobs (Async Worker Pattern)
CREATE TABLE public.generation_jobs (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    job_type TEXT NOT NULL, -- 'recoding', 'fitting', 'analysis'
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'dead')),
    input_params JSONB NOT NULL,
    worker_id UUID, -- Assigned Worker
    result_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.generation_jobs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users view own jobs" 
ON public.generation_jobs FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users create jobs" 
ON public.generation_jobs FOR INSERT WITH CHECK (auth.uid() = user_id);

-- [Constraint] User CANNOT UPDATE jobs. Only Workers (Service Role) update status.
-- No UPDATE policy for 'authenticated' role means they cannot update.


-- 7. Domain 13: API Usage Counters (Atomic Upsert)
CREATE TABLE public.api_usage_counters (
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    counter_key TEXT NOT NULL, -- e.g. 'daily_upload_count'
    count INT DEFAULT 1,
    last_updated TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (user_id, counter_key)
);

ALTER TABLE public.api_usage_counters ENABLE ROW LEVEL SECURITY;

-- 8. Views
-- [D-05] Real-time Balance Calculation
CREATE OR REPLACE VIEW public.v_user_balance AS
SELECT 
    user_id,
    SUM(amount) as balance
FROM 
    public.film_ledger
GROUP BY 
    user_id;

-- Grant permissions
GRANT SELECT ON public.v_user_balance TO authenticated, service_role;
