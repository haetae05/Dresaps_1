-- [DRESAPS V4.0] Worker Logic (RPC)
-- Domain 13 Infrastructure & Security Compliance
-- Generated by Antigravity Agent

-- 1. Atomic Fetch Function [C-03]
-- Used by Edge Function 'generate-ai' to pick up jobs safely.
-- Uses SKIP LOCKED to prevent race conditions in concurrent workers.

CREATE OR REPLACE FUNCTION public.get_next_job(
    p_worker_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_job_record RECORD;
BEGIN
    -- [C-03] LOCKING: Select the oldest 'pending' job and lock it.
    -- SKIP LOCKED ensures we don't wait for other transactions.
    WITH next_job AS (
        SELECT id
        FROM public.generation_jobs
        WHERE status = 'pending'
        ORDER BY created_at ASC
        LIMIT 1
        FOR UPDATE SKIP LOCKED
    )
    UPDATE public.generation_jobs
    SET 
        status = 'processing',
        worker_id = p_worker_id,
        updated_at = NOW()
    FROM next_job
    WHERE public.generation_jobs.id = next_job.id
    RETURNING public.generation_jobs.id, public.generation_jobs.job_type, public.generation_jobs.input_params
    INTO v_job_record;

    -- Return as JSON
    IF v_job_record.id IS NOT NULL THEN
        RETURN jsonb_build_object(
            'id', v_job_record.id,
            'job_type', v_job_record.job_type,
            'input', v_job_record.input_params
        );
    END IF;

    RETURN NULL;
END;
$$;
