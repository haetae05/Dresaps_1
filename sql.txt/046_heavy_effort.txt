-- [DRESAPS V4.0] Heavy Effort (Domain 13)
-- Section 2.2, 2.1, 6.1, 5.2, 4.1
-- Generated by Antigravity Agent

-- 1. Crypto-Shredding System ([Section 2.2, 121])
-- Store encryption keys separately. Deleting the key effectively corrupts the data.

CREATE TABLE IF NOT EXISTS public.user_encryption_keys (
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    encrypted_dek TEXT NOT NULL, -- Data Encryption Key (encrypted by KEK)
    key_version INT DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE OR REPLACE FUNCTION public.shred_user_data(p_user_id UUID)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- 1. Delete the key. This makes all 'measurements' unreadable.
    DELETE FROM public.user_encryption_keys WHERE user_id = p_user_id;
    
    -- 2. Delete the user (Cascade will handle rest, but key deletion is the shredding part).
    DELETE FROM auth.users WHERE id = p_user_id;
END;
$$;


-- 2. Ultra-fast Status View ([Section 2.1, 82])
-- Reduce overhead for client polling (fetching status only).

CREATE OR REPLACE VIEW public.v_job_status_light AS
SELECT 
    id,
    user_id,
    status,
    progress_percentage,
    error_message
FROM public.generation_jobs;
-- Use this view for polling, avoids selecting massive JSON/Text columns.


-- 3. EAS M1 Build Accelerator ([Section 6.1, 448])
/*
   [eas.json Specification]
   - For iOS/Android Builds:
     "ios": {
       "resourceClass": "m1-medium" 
     }
   - M1 machines build 3x faster than Intel-based runners.
   - Cost is slightly higher per minute but lower total cost due to speed.
*/


-- 4. Magazine JSONB Snapshotting ([Section 5.2, 403])
-- Archiving magazines as static JSON to prevent query join overhead on old issues.

CREATE TABLE IF NOT EXISTS public.magazine_archives (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    magazine_id UUID, -- Reference to original if kept
    issue_date DATE NOT NULL,
    snapshot_data JSONB NOT NULL, -- Full denormalized content
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for date-based retrieval
CREATE INDEX IF NOT EXISTS idx_magazine_archives_date ON public.magazine_archives(issue_date);


-- 5. Circuit Breaker Pre-flight Check ([Section 4.1, 316])
/*
   [Worker Logic: Pre-flight Ping]
   - Before accepting a job or initiating heavy GPU task:
   - Worker sends PING to GPU endpoint.
   - If PING fails (Timeout/500) -> Do NOT increment 'attempt_count'.
   - Just release the job back to queue with 'delayed' status.
   - This prevents "burning" retry attempts when the infrastructure is down.
*/


-- [Final Declaration]
-- Dresaps Infrastructure - Heavy Effort Complete. Sincerity overcomes everything.
