-- [DRESAPS V4.1] SOCIAL & CONTENT MODULES
-- Description: Pins, Comments, Reports, Ratings, Hashtags

-- ====================================================
-- 1. SOCIAL MODULE
-- ====================================================

-- [1.1] 핀(PIN) 시스템 (구 팔로우)
-- 설명: 유저는 타인을 '핀'하여 즐겨찾기 할 수 있습니다 (Follower -> PIN).
CREATE TABLE IF NOT EXISTS public.user_pins (
    pinner_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    pinned_user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (pinner_id, pinned_user_id),
    CONSTRAINT no_self_pin CHECK (pinner_id != pinned_user_id)
);

-- [1.2] 댓글 시스템 (대댓글 지원)
-- 설명: 유튜브 스타일의 댓글 및 답글 구조
CREATE TABLE IF NOT EXISTS public.comments (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    post_id UUID REFERENCES public.posts(id) ON DELETE CASCADE NOT NULL,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    parent_id UUID REFERENCES public.comments(id) ON DELETE CASCADE, -- 답글용
    content TEXT NOT NULL CHECK (length(content) > 0),
    is_hidden BOOLEAN DEFAULT FALSE, -- 쉐도우 밴 적용 대상
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- [1.3] 신고 시스템 (AI Justice)
-- 설명: 게시물, 댓글, 유저 프로필 신고 접수
CREATE TABLE IF NOT EXISTS public.reports (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    reporter_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    target_type TEXT NOT NULL CHECK (target_type IN ('POST', 'COMMENT', 'USER')),
    target_id UUID NOT NULL, -- 대상 ID (Generic)
    reason_category TEXT NOT NULL, -- 'SEXUAL', 'HATE', 'SPAM' etc.
    description TEXT,
    status TEXT DEFAULT 'PENDING', -- 'PENDING', 'RESOLVED', 'REJECTED'
    ai_verdict_score INT, -- AI가 판단한 유해성 점수 (0~100)
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ====================================================
-- 2. CONTENT ENRICHMENT
-- ====================================================

-- [2.1] 별점 평가 (Star Rating)
-- 설명: 단순 좋아요(Likes) 대신 0.5~5.0 점수 부여
CREATE TABLE IF NOT EXISTS public.post_ratings (
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    post_id UUID REFERENCES public.posts(id) ON DELETE CASCADE NOT NULL,
    score DECIMAL(2, 1) NOT NULL CHECK (score >= 0.5 AND score <= 5.0),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (user_id, post_id)
);

-- [2.2] 해시태그 저장소
-- 설명: 검색 성능을 위해 정규화
CREATE TABLE IF NOT EXISTS public.hashtags (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    tag TEXT UNIQUE NOT NULL, -- '#ootd', '#summer'
    usage_count INT DEFAULT 1
);

-- [2.3] 게시물-해시태그 연결
CREATE TABLE IF NOT EXISTS public.post_hashtags (
    post_id UUID REFERENCES public.posts(id) ON DELETE CASCADE NOT NULL,
    hashtag_id UUID REFERENCES public.hashtags(id) ON DELETE CASCADE NOT NULL,
    PRIMARY KEY (post_id, hashtag_id)
);

-- ====================================================
-- 3. SECURITY (RLS)
-- ====================================================
ALTER TABLE public.user_pins ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.post_ratings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.hashtags ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.post_hashtags ENABLE ROW LEVEL SECURITY;

-- Policies (Basic)
CREATE POLICY "Public pins" ON public.user_pins FOR SELECT USING (true);
CREATE POLICY "User pin action" ON public.user_pins FOR ALL USING (auth.uid() = pinner_id);

CREATE POLICY "Public comments" ON public.comments FOR SELECT USING (is_hidden = FALSE);
CREATE POLICY "User comment action" ON public.comments FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "User report action" ON public.reports FOR INSERT WITH CHECK (auth.uid() = reporter_id);

CREATE POLICY "Public ratings" ON public.post_ratings FOR SELECT USING (true);
CREATE POLICY "User rate action" ON public.post_ratings FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Public hashtags" ON public.hashtags FOR SELECT USING (true);
CREATE POLICY "Public post tags" ON public.post_hashtags FOR SELECT USING (true);
