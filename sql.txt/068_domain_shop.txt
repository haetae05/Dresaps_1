-- [DRESAPS V4.0] Domain 08: Shop & Atomic Transactions
-- Generated by Antigravity Agent
-- Ref: 068_domain_shop.sql

-- 1. Shop Display View [Requirement 3]
-- Optimization for fetching items with "Is Owned" status in one query.
-- Uses current auth.uid() context.

CREATE OR REPLACE VIEW public.shop_items_view AS
SELECT
    i.id,
    i.category,
    i.brand_name,
    i.rarity,
    i.metadata,
    i.price_points,
    i.price_credits,
    (inv.id IS NOT NULL) AS is_owned
FROM public.items i
LEFT JOIN public.inventory inv
    ON i.id = inv.item_id
    AND inv.user_id = auth.uid(); -- Dynamic Context

-- Grant permissions
GRANT SELECT ON public.shop_items_view TO authenticated, service_role;


-- 2. Atomic Purchase Function [Requirement 1]
-- The "Buy Button" Logic.
-- Wraps Wallet Deduction + Inventory Insert in a single transaction.
-- Automatic Rollback on any Exception.

CREATE OR REPLACE FUNCTION public.purchase_item(
    p_item_id UUID,
    p_currency_type TEXT -- 'POINT' or 'CREDIT'
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER -- Must bypass RLS to insert into inventory
AS $$
DECLARE
    v_user_id UUID;
    v_price BIGINT;
    v_tx_id UUID;
    v_item_ref RECORD;
BEGIN
    v_user_id := auth.uid();

    -- A. Input Validation
    IF v_user_id IS NULL THEN
        RAISE EXCEPTION 'Not authenticated';
    END IF;

    IF p_currency_type NOT IN ('POINT', 'CREDIT') THEN
        RAISE EXCEPTION 'Invalid currency type: %', p_currency_type;
    END IF;

    -- B. Item Validation (Existence & Price)
    SELECT * INTO v_item_ref FROM public.items WHERE id = p_item_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Item not found';
    END IF;

    -- Determine Price
    IF p_currency_type = 'POINT' THEN
        v_price := v_item_ref.price_points;
    ELSE
        v_price := v_item_ref.price_credits;
    END IF;

    -- Sanity Check
    IF v_price IS NULL OR v_price < 0 THEN
         RAISE EXCEPTION 'Item not available for purchase with %', p_currency_type;
    END IF;

    -- C. Duplicate Check
    -- If user already owns it, abort.
    IF EXISTS (SELECT 1 FROM public.inventory WHERE user_id = v_user_id AND item_id = p_item_id) THEN
        RAISE EXCEPTION 'Item already owned';
    END IF;

    -- D. Execution (The Atomic Block)
    
    -- 1. Deduct Money (Calls 066 logic)
    -- This handles Locking (SELECT FOR UPDATE) and Balance Check.
    -- If insufficient funds, it raises exception -> Rollback entire function.
    v_tx_id := public.process_transaction(
        v_user_id,
        -v_price, -- Negative for withdrawal
        p_currency_type,
        'PURCHASE',
        'Purchase: ' || v_item_ref.brand_name || ' (' || v_item_ref.category || ')',
        jsonb_build_object('item_id', p_item_id)
    );

    -- 2. Grant Item (Calls 067 logic implicitly via insert)
    -- If this violates unique constraint (race condition duplicate), it raises exception -> Rollback money deduction.
    INSERT INTO public.inventory (user_id, item_id, is_equipped)
    VALUES (v_user_id, p_item_id, FALSE);

    -- 3. Audit Log (Shop Specific)
    INSERT INTO public.audit_logs (action, target_id, metadata)
    VALUES (
        'SHOP_PURCHASE',
        v_user_id,
        jsonb_build_object(
            'item_id', p_item_id,
            'cost', v_price,
            'currency', p_currency_type,
            'tx_id', v_tx_id
        )
    );

    -- E. Return Success Receipt
    RETURN jsonb_build_object(
        'success', true,
        'tx_id', v_tx_id,
        'item_id', p_item_id,
        'price', v_price,
        'currency', p_currency_type
    );

EXCEPTION WHEN OTHERS THEN
    -- Verify Rollback happened (implicitly)
    -- We can log the failure if we want, but raising ensures Client knows.
    RAISE;
END;
$$;
