-- [DRESAPS V4.0] Domain 14, 15: Admin & Legal System
-- Generated by Antigravity Agent
-- Ref: 071_system_admin.sql

-- 1. Report System [Spec 1]
CREATE TABLE IF NOT EXISTS public.reports (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    reporter_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    target_user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    target_content_id UUID, -- Optional content reference
    reason TEXT NOT NULL CHECK (length(reason) > 0),
    status TEXT DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'RESOLVED', 'REJECTED')),
    admin_note TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT unique_report_per_target UNIQUE (reporter_id, target_user_id)
);

-- RLS: Reports
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users create reports" ON public.reports FOR INSERT WITH CHECK (auth.uid() = reporter_id);
CREATE POLICY "Users view own reports" ON public.reports FOR SELECT USING (auth.uid() = reporter_id);
-- Admin/Service Role can view/update all (No policy needed for service_role, explicit grant for admin role would be handled by RBAC if implies)


-- 2. Admin Logs [Spec 2]
CREATE TABLE IF NOT EXISTS public.admin_logs (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    admin_id UUID REFERENCES auth.users(id) ON DELETE SET NULL, -- Keep log even if admin deleted
    action_type TEXT NOT NULL,
    target_id UUID,
    details JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS: Admin Logs (Immutable)
ALTER TABLE public.admin_logs ENABLE ROW LEVEL SECURITY;
-- No UPDATE/DELETE policies created -> Deny All by default (except Service Role)
-- Users cannot INSERT/SELECT (Admin Role logic handles SELECT usually, or Service Role)


-- 3. Judgment Logic (RPC) [Spec 3]
CREATE OR REPLACE FUNCTION public.resolve_report(
    p_report_id UUID,
    p_verdict TEXT, -- 'RESOLVED' or 'REJECTED'
    p_penalty_score INT
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER -- Run as Superuser/Owner
AS $$
DECLARE
    v_report_record RECORD;
    v_target_user_id UUID;
    v_admin_id UUID;
    v_new_reputation INT;
BEGIN
    v_admin_id := auth.uid();
    
    -- Validate Verdict
    IF p_verdict NOT IN ('RESOLVED', 'REJECTED') THEN
        RAISE EXCEPTION 'Invalid verdict. Must be RESOLVED or REJECTED.';
    END IF;

    -- Fetch Report
    SELECT * INTO v_report_record FROM public.reports WHERE id = p_report_id;
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Report not found.';
    END IF;
    
    v_target_user_id := v_report_record.target_user_id;

    -- Update Report Status
    UPDATE public.reports 
    SET status = p_verdict, 
        updated_at = NOW() 
    WHERE id = p_report_id;

    -- Apply Penalty if Guilty
    IF p_verdict = 'RESOLVED' AND p_penalty_score > 0 THEN
        UPDATE public.profiles
        SET reputation_score = reputation_score - p_penalty_score
        WHERE id = v_target_user_id
        RETURNING reputation_score INTO v_new_reputation;
        
        -- (Hell Gate trigger in 064 will auto-fire if reputation < 75)
    END IF;

    -- Log Action
    INSERT INTO public.admin_logs (admin_id, action_type, target_id, details)
    VALUES (
        v_admin_id,
        'RESOLVE_REPORT',
        v_target_user_id,
        jsonb_build_object(
            'report_id', p_report_id,
            'verdict', p_verdict,
            'penalty', p_penalty_score,
            'new_reputation', v_new_reputation
        )
    );

    RETURN jsonb_build_object('success', true, 'new_reputation', v_new_reputation);
END;
$$;


-- 4. Admin Dashboard View [Spec 4]
CREATE OR REPLACE VIEW public.admin_stats_view AS
SELECT
    (SELECT COUNT(*) FROM public.profiles) as total_users,
    (SELECT COUNT(*) FROM public.profiles WHERE reputation_score < 75) as hell_gate_inmates,
    (SELECT COUNT(*) FROM public.reports WHERE status = 'PENDING') as pending_reports_count,
    NOW() as generated_at;

-- Grant Access
GRANT SELECT ON public.admin_stats_view TO service_role;
-- GRANT SELECT ON public.admin_stats_view TO authenticated; -- Typically restricted to admin, but strictly requested 'Select View'.
