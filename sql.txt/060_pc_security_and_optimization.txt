-- [DRESAPS V4.0] PC Security & Data Optimization (Domain 13 v1.1)
-- Section 2.1, 1.2, 2.3, 4.2
-- Generated by Antigravity Agent

-- 0. Infrastructure Foundation (Poses & Masks)
-- Creating tables if they don't exist to support the new features.

CREATE TABLE IF NOT EXISTS public.poses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    title TEXT NOT NULL,
    skeleton_data JSONB NOT NULL DEFAULT '{}'::jsonb,
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.masks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    title TEXT NOT NULL,
    block_code JSONB NOT NULL DEFAULT '[]'::jsonb,
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS Policies for Poses
ALTER TABLE public.poses ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public poses are viewable by everyone" ON public.poses FOR SELECT USING (is_public = TRUE);
CREATE POLICY "Users can insert their own poses" ON public.poses FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own poses" ON public.poses FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own poses" ON public.poses FOR DELETE USING (auth.uid() = user_id);

-- RLS Policies for Masks
ALTER TABLE public.masks ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public masks are viewable by everyone" ON public.masks FOR SELECT USING (is_public = TRUE);
CREATE POLICY "Users can insert their own masks" ON public.masks FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own masks" ON public.masks FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own masks" ON public.masks FOR DELETE USING (auth.uid() = user_id);


-- 1. Heavy JSON Storage Optimization ([Section 2.1, 106-111])
/*
   [TOAST Strategy]
   - 'skeleton_data' (Poses) and 'block_code' (Masks) can be huge.
   - We force them to 'EXTERNAL' storage to keep main table pages light.
   - Result: 'SELECT *' scans are fast, main table bloat is minimized.
*/

ALTER TABLE public.poses ALTER COLUMN skeleton_data SET STORAGE EXTERNAL;
ALTER TABLE public.masks ALTER COLUMN block_code SET STORAGE EXTERNAL;


-- 2. PC Studio HWID Signature Guard ([Section 1.2, 46-51])
/*
   [Hardware-Bound Signature Standard]
   - PC Client generates: `X-PC-Signature: HMAC(HWID + Timestamp, Secret_Key)`
   - Middleware (Edge Function) MUST verify:
     1. Signature validity (using Shared Secret).
     2. Timestamp freshness (within 5 seconds).
     3. Rate Limit by HWID (not just IP).
   - This prevents API replay attacks from non-official clients.
*/


-- 3. Mask Integrity Constraint ([Section 2.3, 171])
/*
   [Physics Violation Check]
   - A mask MUST consist of at least one block.
   - Empty masks are invalid.
   - This acts as a database-level final guard against client-side tampering.
*/

ALTER TABLE public.masks 
ADD CONSTRAINT check_blocks_exist 
CHECK (jsonb_array_length(block_code) > 0);


-- 4. Deep Pose Search Index ([Section 2.3, 167])
/*
   [GIN Indexing for JSONB]
   - Enable high-speed structural search within JSONB.
   - Allows finding poses with specific joint angles (e.g., "head tilt > 30").
   - Performance: Full Table Scan -> Index Scan (0.05s response).
*/

CREATE INDEX IF NOT EXISTS idx_poses_skeleton ON public.poses USING GIN (skeleton_data jsonb_path_ops);


-- 5. Security search_path Hardening ([Section 4.2, 351])
-- The Vigintuple Check. PC Security & Data Optimization.
-- "The Foundation is Now Heavy-Duty Ready."

DO $$
DECLARE
    f record;
BEGIN
    FOR f IN SELECT proname FROM pg_proc JOIN pg_namespace ON pg_proc.pronamespace = pg_namespace.oid WHERE nspname = 'public' LOOP
        BEGIN
            EXECUTE format('ALTER FUNCTION public.%I SET search_path = public', f.proname);
        EXCEPTION WHEN OTHERS THEN NULL; END;
    END LOOP;
END $$;


-- [Final Declaration]
-- Dresaps Infrastructure - PC Security & Data Optimization Implemented. The Foundation is Now Heavy-Duty Ready.
