-- [DRESAPS V4.0] 03_Master_Security.sql
-- Master Row Level Security (RLS) Policies
-- Generated by Antigravity Agent
-- Strict adherence to Zero Trust model.

-- 0. Global Setup
-- Ensure RLS is enabled on all tables (Idempotent)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_body_specs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.wallets ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.inventory ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.posts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.likes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.relationships ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.style_cup_matches ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.style_cup_votes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.generation_jobs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_audit_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.storage_delete_queue ENABLE ROW LEVEL SECURITY;

-- 1. Profiles (Shadow Profile Protection) [Reg 1]
-- SELECT: Public
CREATE POLICY "Public profiles are viewable by everyone" 
ON public.profiles FOR SELECT USING (true);

-- INSERT: Creating a user is handled by Trigger (System Only).
-- Block manual insert by 'authenticated' role. (Implicit Deny if no policy)

-- UPDATE: Users update OWN display_name, bio, avatar_url.
-- CRITICAL: Prevent update of sensitive columns (username, reputation, etc.)
-- We use a combination of policy + column privileges.
REVOKE UPDATE ON public.profiles FROM authenticated;
GRANT UPDATE (display_name, bio, avatar_url) ON public.profiles TO authenticated;

CREATE POLICY "Users can update own profile" 
ON public.profiles FOR UPDATE 
USING (auth.uid() = id) 
WITH CHECK (auth.uid() = id);

-- DELETE: Users delete OWN profile.
CREATE POLICY "Users can delete own profile" 
ON public.profiles FOR DELETE USING (auth.uid() = id);


-- 2. Wallets & Transactions (Financial Fortification) [Reg 2]
-- Wallets: Owner Only SELECT. No Write.
CREATE POLICY "Users view own wallet" 
ON public.wallets FOR SELECT USING (auth.uid() = user_id);

-- Transactions: Owner Only SELECT. No Write.
CREATE POLICY "Users view own transactions" 
ON public.transactions FOR SELECT USING (auth.uid() = user_id);

-- Explicitly Revoke Write Permissions for authenticated to ensure Functions are the only way
REVOKE INSERT, UPDATE, DELETE ON public.wallets FROM authenticated;
REVOKE INSERT, UPDATE, DELETE ON public.transactions FROM authenticated;


-- 3. Inventory & Items (Asset Protection) [Reg 3]
-- Items: Public SELECT. No Write.
CREATE POLICY "Public view items" 
ON public.items FOR SELECT USING (true);

-- Inventory: Owner Only SELECT. No Write.
CREATE POLICY "Users view own inventory" 
ON public.inventory FOR SELECT USING (auth.uid() = user_id);

-- Revoke Write Permissions
REVOKE INSERT, UPDATE, DELETE ON public.items FROM authenticated;
REVOKE INSERT, UPDATE, DELETE ON public.inventory FROM authenticated;


-- 4. Posts & Content (Visibility Logic) [Reg 4]
-- Posts: Public SELECT (Filtered by Hidden).
CREATE POLICY "Public view posts" 
ON public.posts FOR SELECT 
USING (is_hidden = FALSE OR auth.uid() = user_id);

-- INSERT: Authenticated Users.
CREATE POLICY "Users create posts" 
ON public.posts FOR INSERT 
WITH CHECK (auth.uid() = user_id);

-- UPDATE: Owner Only.
CREATE POLICY "Users update own posts" 
ON public.posts FOR UPDATE 
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- DELETE: Owner Only.
CREATE POLICY "Users delete own posts" 
ON public.posts FOR DELETE USING (auth.uid() = user_id);

-- Storage Queue: Deny All (System Only)
-- Implicit Deny.


-- 5. Body Specs (Privacy Vault) [Reg 5]
-- ALL: Owner Only. CRITICAL: No Public Access.
CREATE POLICY "Users manage own body specs" 
ON public.user_body_specs FOR ALL 
USING (auth.uid() = user_id) 
WITH CHECK (auth.uid() = user_id);


-- 6. Jobs & Infrastructure [Reg 6]
-- Generation Jobs: Owner Read/Insert.
CREATE POLICY "Users view own jobs" 
ON public.generation_jobs FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users create jobs" 
ON public.generation_jobs FOR INSERT 
WITH CHECK (auth.uid() = user_id);

-- UPDATE: Deny (Workers update).
REVOKE UPDATE ON public.generation_jobs FROM authenticated;

-- Admin Audit Logs: Admin Read Only. 
-- Check role exists in profiles.
CREATE POLICY "Admins view audit logs" 
ON public.admin_audit_logs FOR SELECT 
USING (
    EXISTS (
        SELECT 1 FROM public.profiles 
        WHERE id = auth.uid() 
        AND role IN ('admin', 'gm')
    )
);

-- Write: System Only.
REVOKE INSERT, UPDATE, DELETE ON public.admin_audit_logs FROM authenticated;


-- 7. Gamification [Reg 7]
-- Style Cup Votes: Public Read.
CREATE POLICY "Public view votes" 
ON public.style_cup_votes FOR SELECT USING (true);

-- WRITE: Deny All (Use Function).
REVOKE INSERT, UPDATE, DELETE ON public.style_cup_votes FROM authenticated;

-- Style Cup Matches: Public Read.
CREATE POLICY "Public view matches" 
ON public.style_cup_matches FOR SELECT USING (true);

-- WRITE: Deny All (System/Admin).
REVOKE INSERT, UPDATE, DELETE ON public.style_cup_matches FROM authenticated;


-- 8. Other Tables (Likes, Relationships)
-- Likes: Public Read, Owner Write.
CREATE POLICY "Public view likes" 
ON public.likes FOR SELECT USING (true);

CREATE POLICY "Users manage likes" 
ON public.likes FOR ALL 
USING (auth.uid() = user_id) 
WITH CHECK (auth.uid() = user_id);

-- Relationships: Public Read (Followings are public usually), Owner Write.
CREATE POLICY "Public view relationships" 
ON public.relationships FOR SELECT USING (true);

CREATE POLICY "Users manage relationships" 
ON public.relationships FOR ALL 
USING (auth.uid() = follower_id) 
WITH CHECK (auth.uid() = follower_id);
